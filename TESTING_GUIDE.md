# 🧪 ПОЛНОЕ РУКОВОДСТВО ПО ТЕСТИРОВАНИЮ ПРОЕКТА

## 📋 СОДЕРЖАНИЕ
1. [Подготовка окружения](#подготовка-окружения)
2. [Создание базы данных](#создание-базы-данных)
3. [Настройка .env файла](#настройка-env-файла)
4. [План тестирования](#план-тестирования)
5. [Проверка функционала](#проверка-функционала)

---

## 🔧 ПОДГОТОВКА ОКРУЖЕНИЯ

### 1. Установка зависимостей
```bash
# Активация виртуального окружения
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows

# Установка зависимостей
pip install -r requirements.txt
```

### 2. Очистка от лишних файлов
```bash
# Удалить дубликат models.py из корня (если есть)
# Файл должен быть только в app/models.py

# Убедиться что payment_routes.py не используется
# (должен быть только /api/order/create)
```

---

## 🗄️ СОЗДАНИЕ БАЗЫ ДАННЫХ

### Вариант 1: Через миграции (РЕКОМЕНДУЕТСЯ)
```bash
# 1. Инициализация миграций (если еще не сделано)
flask db init

# 2. Создание миграции для новых индексов
flask db migrate -m "Add indexes for performance"

# 3. Применение миграций
flask db upgrade

# 4. Создание начальных данных
python create_database_final_v3.py
```

### Вариант 2: Прямое создание (для разработки)
```bash
python create_database_final_v3.py
```

**⚠️ ВАЖНО:** После создания БД через `db.create_all()` обязательно запустите миграции для применения индексов:
```bash
flask db upgrade
```

---

## ⚙️ НАСТРОЙКА .ENV ФАЙЛА

### Правильный .env для PRODUCTION

```env
# ═══════════════════════════════════════════════════════════════
# КОНФИГУРАЦИЯ ДЛЯ PRODUCTION (BEGET) - MainStream Shop
# ═══════════════════════════════════════════════════════════════

# ───────────────────────────────────────────────────────────────
# FLASK НАСТРОЙКИ
# ───────────────────────────────────────────────────────────────
FLASK_ENV=production
SECRET_KEY=ваш_секретный_ключ_минимум_32_символа
SESSION_COOKIE_SECURE=True
WTF_CSRF_SSL_STRICT=True

# ───────────────────────────────────────────────────────────────
# БАЗА ДАННЫХ
# ───────────────────────────────────────────────────────────────
DATABASE_URL=sqlite:////opt/msshop/instance/app.db
# ИЛИ для PostgreSQL:
# DATABASE_URL=postgresql://user:password@localhost/mainstreamshop

# ───────────────────────────────────────────────────────────────
# EMAIL НАСТРОЙКИ (Beget SMTP)
# ───────────────────────────────────────────────────────────────
MAIL_SERVER=smtp.beget.com
MAIL_PORT=465
MAIL_USE_TLS=False
MAIL_USE_SSL=True
MAIL_USERNAME=orders@mainstreamfs.ru
MAIL_PASSWORD=ваш_пароль_от_email
MAIL_DEFAULT_SENDER=orders@mainstreamfs.ru

# ───────────────────────────────────────────────────────────────
# TELEGRAM BOT
# ───────────────────────────────────────────────────────────────
TELEGRAM_BOT_TOKEN=ваш_токен_бота
TELEGRAM_WEBHOOK_URL=https://mainstreamfs.ru/telegram/webhook

# ───────────────────────────────────────────────────────────────
# CLOUDPAYMENTS НАСТРОЙКИ
# ───────────────────────────────────────────────────────────────
CLOUDPAYMENTS_PUBLIC_ID=ваш_public_id
CLOUDPAYMENTS_API_SECRET=ваш_api_secret
CLOUDPAYMENTS_TEST_MODE=False
CLOUDPAYMENTS_WEBHOOK_URL=https://mainstreamfs.ru/api/cloudpayments/webhook

# ───────────────────────────────────────────────────────────────
# ДОМЕН И ПОРТ
# ───────────────────────────────────────────────────────────────
DOMAIN=mainstreamfs.ru
PORT=5002
SITE_URL=https://mainstreamfs.ru

# ───────────────────────────────────────────────────────────────
# REDIS (опционально, для rate limiting)
# ───────────────────────────────────────────────────────────────
REDIS_URL=memory://
# ИЛИ для Redis сервера:
# REDIS_URL=redis://localhost:6379/0

# ───────────────────────────────────────────────────────────────
# ДОПОЛНИТЕЛЬНЫЕ НАСТРОЙКИ
# ───────────────────────────────────────────────────────────────
TEST_MODE=False
LOG_TO_STDOUT=True
```

### Важные замечания:
- ✅ `SECRET_KEY` - минимум 32 символа, сгенерируйте случайный
- ✅ `MAIL_PASSWORD` - НЕ должно быть в коде, только в .env
- ✅ `CLOUDPAYMENTS_API_SECRET` - НЕ должно быть в коде
- ✅ `TELEGRAM_BOT_TOKEN` - НЕ должно быть в коде
- ✅ `SESSION_COOKIE_SECURE=True` для production
- ✅ `WTF_CSRF_SSL_STRICT=True` для production

---

## 📝 ПЛАН ТЕСТИРОВАНИЯ

### Этап 1: Базовое тестирование инфраструктуры

#### 1.1 Проверка запуска приложения
```bash
# Запуск приложения
python run.py
# или
gunicorn -c gunicorn_config.py wsgi:app
```

**Что проверить:**
- ✅ Приложение запускается без ошибок
- ✅ Все маршруты доступны (200 OK)
- ✅ Статические файлы загружаются
- ✅ База данных подключена

#### 1.2 Проверка авторизации
**URL:** `/auth/login`

**Тестовые аккаунты:**
- Admin: `admin@mainstreamfs.ru` / `password123`
- Operator: `operator@mainstreamfs.ru` / `password123`
- Mom: `mom@mainstreamfs.ru` / `password123`

**Что проверить:**
- ✅ Вход работает для всех ролей
- ✅ Редирект на правильную панель после входа
- ✅ Защита маршрутов по ролям
- ✅ Выход из системы

---

### Этап 2: Тестирование роли ADMIN

#### 2.1 Управление пользователями
**URL:** `/admin/users`

**Тесты:**
- ✅ Просмотр списка пользователей
- ✅ Создание нового пользователя
- ✅ Редактирование пользователя
- ✅ Смена пароля
- ✅ Активация/деактивация пользователя

#### 2.2 Управление турнирами
**URL:** `/admin/events`

**Тесты:**
- ✅ Создание турнира
- ✅ Загрузка XML файла с турниром
- ✅ Парсинг XML работает корректно
- ✅ Редактирование турнира
- ✅ Активация/деактивация турнира

#### 2.3 Управление заказами
**URL:** `/admin/orders`

**Тесты:**
- ✅ Просмотр всех заказов
- ✅ Фильтрация по статусу
- ✅ Поиск по номеру заказа/email
- ✅ Просмотр деталей заказа
- ✅ Изменение статуса заказа
- ✅ Просмотр платежей

#### 2.4 Финансовая аналитика
**URL:** `/admin/finance`

**Тесты:**
- ✅ Отображение статистики
- ✅ Фильтры по датам
- ✅ Экспорт отчетов

#### 2.5 Audit Log
**URL:** `/admin/audit`

**Тесты:**
- ✅ Просмотр логов действий
- ✅ Фильтрация по типу действия
- ✅ Фильтрация по пользователю
- ✅ Экспорт логов

---

### Этап 3: Тестирование роли OPERATOR

#### 3.1 Дашборд
**URL:** `/operator/dashboard`

**Тесты:**
- ✅ Отображение статистики
- ✅ Список новых заказов
- ✅ Список заказов в обработке

#### 3.2 Новые заказы
**URL:** `/operator/new-orders`

**Тесты:**
- ✅ Видны только оплаченные заказы (`status='paid'`)
- ✅ Заказы без оператора
- ✅ Кнопка "Взять в работу" работает
- ✅ После взятия заказ переходит в `processing`

#### 3.3 Обработка заказа
**URL:** `/operator/order/<id>`

**Тесты:**
- ✅ Просмотр деталей заказа
- ✅ Загрузка ссылок на видео
- ✅ Добавление комментариев
- ✅ Отметка "Требуется частичный возврат"
- ✅ Отправка ссылок клиенту
- ✅ Смена статуса заказа

#### 3.4 Чат с MOM
**URL:** `/operator/order/<id>` (раздел чата)

**Тесты:**
- ✅ Отправка сообщений
- ✅ Прикрепление файлов
- ✅ Получение ответов от MOM

---

### Этап 4: Тестирование роли MOM

#### 4.1 Дашборд
**URL:** `/mom/dashboard`

**Тесты:**
- ✅ Счетчики заказов требующих действий
- ✅ Недавние заказы

#### 4.2 Заказы требующие принятия платежа
**URL:** `/mom/need-payment-orders`

**Тесты:**
- ✅ Видны только заказы со статусом `links_sent` или `refund_required`
- ✅ Кнопка "Принять деньги" доступна
- ✅ Можно указать сумму для частичного принятия
- ✅ После принятия статус меняется на `completed` или `completed_partial_refund`

#### 4.3 Частичный возврат
**URL:** `/mom/refund-orders`

**Тесты:**
- ✅ Просмотр заказов требующих возврата
- ✅ Возврат части суммы
- ✅ Полный возврат
- ✅ Статус платежа обновляется корректно

#### 4.4 Финансовые отчеты
**URL:** `/mom/reports`

**Тесты:**
- ✅ Статистика по периодам
- ✅ Фильтры работают
- ✅ Экспорт отчетов

---

### Этап 5: Тестирование процесса заказа (CUSTOMER)

#### 5.1 Главная страница
**URL:** `/`

**Тесты:**
- ✅ Отображение активных турниров
- ✅ Переход к выбору категории
- ✅ Корзина пустая изначально

#### 5.2 Выбор категории и спортсмена
**URL:** `/shop`, `/tournament/<id>`, `/category/<id>/athletes`

**Тесты:**
- ✅ Просмотр категорий
- ✅ Просмотр спортсменов
- ✅ Добавление в корзину
- ✅ Обновление суммы корзины

#### 5.3 Корзина
**URL:** `/cart`

**Тесты:**
- ✅ Отображение товаров в корзине
- ✅ Изменение количества
- ✅ Удаление товаров
- ✅ Пересчет суммы
- ✅ Переход к оформлению

#### 5.4 Оформление заказа
**URL:** `/checkout`

**Тесты:**
- ✅ Заполнение контактных данных
- ✅ Валидация email
- ✅ Создание заказа через `/api/order/create`
- ✅ Заказ получает статус `checkout_initiated`
- ✅ Редирект на страницу оплаты

#### 5.5 Оплата
**URL:** `/payment?order_id=<id>`

**Тесты:**
- ✅ Отображение суммы заказа
- ✅ Загрузка CloudPayments виджета
- ✅ В тестовом режиме: платеж проходит
- ✅ После оплаты: статус меняется на `paid`
- ✅ Отправка email подтверждения
- ✅ Редирект на страницу успеха

#### 5.6 Отслеживание заказа
**URL:** `/track-order`

**Тесты:**
- ✅ Поиск заказа по номеру
- ✅ Отображение статуса
- ✅ История изменений

---

### Этап 6: Тестирование CloudPayments интеграции

#### 6.1 Webhook обработка

**Тестирование через curl:**
```bash
# Check webhook (проверка возможности оплаты)
curl -X POST https://mainstreamfs.ru/api/cloudpayments/webhook \
  -H "Content-Type: application/json" \
  -H "X-Content-Signature: sha256=<signature>" \
  -d '{
    "TransactionId": 123456,
    "InvoiceId": "MS20241201000001",
    "Amount": 1000.00,
    "Currency": "RUB",
    "Email": "test@example.com",
    "PaymentMethod": "card",
    "Status": "Authorized"
  }'
```

**Что проверить:**
- ✅ Верификация подписи работает
- ✅ Обработка всех типов уведомлений (Check, Pay, Fail, Confirm, Refund, Cancel)
- ✅ Идемпотентность (повторные webhook не создают дубликаты)
- ✅ Обновление статусов заказов и платежей

#### 6.2 Платежные операции

**Через админ-панель:**
- ✅ Capture (принятие денег MOM)
- ✅ Refund (возврат)
- ✅ Void (отмена авторизованного платежа)

**Что проверить:**
- ✅ Валидация сумм
- ✅ Проверка статусов платежей
- ✅ Обновление в базе данных
- ✅ Логирование в audit log

---

### Этап 7: Тестирование безопасности

#### 7.1 Аутентификация
- ✅ Нельзя получить доступ без входа
- ✅ Нельзя подделать сессию
- ✅ Пароли хешируются (не хранятся в открытом виде)

#### 7.2 Авторизация
- ✅ OPERATOR видит только свои заказы (или не назначенные)
- ✅ MOM видит все заказы
- ✅ ADMIN видит все
- ✅ CUSTOMER видит только свои заказы

#### 7.3 Валидация данных
- ✅ Email валидация работает
- ✅ Файлы валидируются по типу и размеру
- ✅ SQL injection защита
- ✅ XSS защита (данные экранируются)

#### 7.4 CSRF защита
- ✅ CSRF токены обязательны для POST запросов
- ✅ API endpoints защищены

---

### Этап 8: Тестирование производительности

#### 8.1 N+1 запросы
**Проверка через логи SQL:**
```python
# В config.py добавить для dev:
SQLALCHEMY_ECHO = True
```

**Что проверить:**
- ✅ При загрузке списка заказов делается минимум запросов
- ✅ Eager loading работает (используется `joinedload`)

#### 8.2 Индексы
**Проверка в БД:**
```sql
-- SQLite
.schema orders
.indexes orders

-- PostgreSQL
\d orders
```

**Что проверить:**
- ✅ Индексы созданы на: `status`, `customer_id`, `operator_id`, `event_id`, `created_at`
- ✅ Запросы с фильтрами быстрые

---

## 🔍 ЧЕКЛИСТ ПОЛНОГО ТЕСТИРОВАНИЯ

### ✅ Инфраструктура
- [ ] Приложение запускается
- [ ] База данных создана
- [ ] Миграции применены
- [ ] Начальные данные созданы
- [ ] .env файл настроен

### ✅ Роль ADMIN
- [ ] Управление пользователями
- [ ] Управление турнирами
- [ ] Загрузка XML
- [ ] Управление заказами
- [ ] Финансовая аналитика
- [ ] Audit log

### ✅ Роль OPERATOR
- [ ] Дашборд
- [ ] Взятие заказов в работу
- [ ] Обработка заказов
- [ ] Загрузка ссылок
- [ ] Чат с MOM
- [ ] Отправка ссылок клиенту

### ✅ Роль MOM
- [ ] Дашборд
- [ ] Принятие платежей
- [ ] Частичный возврат
- [ ] Полный возврат
- [ ] Финансовые отчеты

### ✅ Процесс заказа
- [ ] Выбор турнира
- [ ] Выбор категории и спортсмена
- [ ] Добавление в корзину
- [ ] Оформление заказа
- [ ] Оплата
- [ ] Получение ссылок
- [ ] Отслеживание заказа

### ✅ CloudPayments
- [ ] Создание платежа
- [ ] Webhook обработка
- [ ] Capture (принятие денег)
- [ ] Refund (возврат)
- [ ] Void (отмена)

### ✅ Безопасность
- [ ] Аутентификация
- [ ] Авторизация по ролям
- [ ] Валидация данных
- [ ] CSRF защита
- [ ] SQL injection защита
- [ ] XSS защита

### ✅ Производительность
- [ ] Нет N+1 запросов
- [ ] Индексы работают
- [ ] Страницы загружаются быстро

---

## 🐛 ОБНАРУЖЕНИЕ ПРОБЛЕМ

### Частые проблемы и решения:

1. **Ошибка подключения к БД**
   - Проверьте путь в `DATABASE_URL`
   - Убедитесь что директория существует
   - Проверьте права доступа

2. **Миграции не применяются**
   - Проверьте `migrations/versions/` на наличие файлов
   - Запустите `flask db upgrade` вручную

3. **Индексы не созданы**
   - Проверьте что миграция применена
   - Создайте новую миграцию: `flask db migrate -m "Add indexes"`

4. **Email не отправляется**
   - Проверьте настройки SMTP в .env
   - Проверьте логи на ошибки
   - Тестируйте через консоль Python

5. **CloudPayments не работает**
   - Проверьте API ключи в .env
   - Проверьте webhook URL
   - Используйте тестовый режим для проверки

---

## 📊 МЕТРИКИ УСПЕШНОГО ТЕСТИРОВАНИЯ

- ✅ Все CRUD операции работают
- ✅ Все роли имеют правильный доступ
- ✅ Платежи обрабатываются корректно
- ✅ Email уведомления отправляются
- ✅ Нет критических ошибок в логах
- ✅ Производительность приемлемая
- ✅ Безопасность соблюдена

---

## 🚀 ГОТОВНОСТЬ К PRODUCTION

Перед переходом в production убедитесь что:

1. ✅ Все тесты пройдены
2. ✅ .env файл настроен правильно (все секреты)
3. ✅ `FLASK_ENV=production`
4. ✅ `SECRET_KEY` сгенерирован и безопасен
5. ✅ `SESSION_COOKIE_SECURE=True`
6. ✅ `WTF_CSRF_SSL_STRICT=True`
7. ✅ `TEST_MODE=False`
8. ✅ `CLOUDPAYMENTS_TEST_MODE=False`
9. ✅ База данных бэкапится регулярно
10. ✅ Логи настроены и мониторятся

