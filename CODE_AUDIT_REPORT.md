# –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –∫–æ–¥–∞ MainStream Shop
## –î–∞—Ç–∞: 2025-11-07
## –°—Ç–∞—Ç—É—Å: –ü–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –¥–µ–ø–ª–æ–µ–º

---

## üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (—Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

### 1. **Race Condition –≤ webhook CloudPayments**
**–§–∞–π–ª:** `app/api/cloudpayments_endpoints.py:196-208`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `with db.session.begin()` —Å `select().with_for_update()`, –ù–û Flask-SQLAlchemy —É–∂–µ —Å–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ request. –í–ª–æ–∂–µ–Ω–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å `InvalidRequestError: A transaction is already begun`.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- Webhook –º–æ–∂–µ—Ç –ø–∞–¥–∞—Ç—å —Å –æ—à–∏–±–∫–æ–π –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π –µ—Å–ª–∏ race condition –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –¥–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –ü–æ—Ç–µ—Ä—è –ø–ª–∞—Ç–µ–∂–µ–π –∫–ª–∏–µ–Ω—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
with db.session.begin():
    stmt = select(Payment).where(...).with_for_update()
    
# –ü–†–ê–í–ò–õ–¨–ù–û:
stmt = select(Payment).where(...).with_for_update()
existing_payment = db.session.scalar(stmt)
# Flask-SQLAlchemy —É–∂–µ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
```

---

### 2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–æ–ª—è—Ö**
**–§–∞–π–ª:** `app/models.py`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—è `Order.payment_expires_at`, `Order.status`, `Payment.status` –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ WHERE —É—Å–ª–æ–≤–∏—è—Ö scheduler'–∞ –∏ API, –Ω–æ –Ω–µ –∏–º–µ—é—Ç –∏–Ω–¥–µ–∫—Å–æ–≤.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ —Ä–æ—Å—Ç–µ –±–∞–∑—ã (Full Table Scan)
- Scheduler `cancel_expired_orders` –±—É–¥–µ—Ç —Ç–æ—Ä–º–æ–∑–∏—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É
- Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±—É–¥–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ–π

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
```python
# –í –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:
op.create_index('ix_orders_payment_expires_at', 'orders', ['payment_expires_at'])
op.create_index('ix_orders_status_operator', 'orders', ['status', 'operator_id'])
op.create_index('ix_payments_status', 'payments', ['status'])
```

---

### 3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ webhook**
**–§–∞–π–ª:** `app/api/cloudpayments_endpoints.py:47`
**–ü—Ä–æ–±–ª–µ–º–∞:** 
```python
logger.warning(f'Invalid webhook signature. Raw data: {raw_data[:500]}')
```
–õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö webhook, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
- –ù–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç (CardMask)
- Email –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–∞—Ä—É—à–µ–Ω–∏–µ GDPR/152-–§–ó
- –£—Ç–µ—á–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–≥–∏
- –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
logger.warning(f'Invalid webhook signature. TransactionId: {data.get("TransactionId")}, InvoiceId: {data.get("InvoiceId")}')
# –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –≤ DEBUG —Ä–µ–∂–∏–º–µ
logger.debug(f'Full webhook data: {raw_data[:200]}...')
```

---

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∞–π–º–∞—É—Ç–∞ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤**
**–§–∞–π–ª:** `app/utils/cloudpayments.py:291, 444, 504`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–ø—Ä–æ—Å—ã –∫ CloudPayments API –∏–º–µ—é—Ç `timeout=30`, –Ω–æ –µ—Å–ª–∏ API –∑–∞–≤–∏—Å–Ω–µ—Ç, —ç—Ç–æ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç worker –Ω–∞ 30 —Å–µ–∫—É–Ω–¥.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- DoS –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å CloudPayments
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö workers Gunicorn
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –∏ retry logic
response = requests.post(url, ..., timeout=(3, 10))  # (connect, read)
```

---

### 5. **SQL Injection —á–µ—Ä–µ–∑ cast –≤ mom/routes.py**
**–§–∞–π–ª:** `app/mom/routes.py:44`
**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
(Order.id.cast(db.String).contains(search))
```
–•–æ—Ç—è SQLAlchemy —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `cast` —Å `contains` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–º –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–∏–∞–ª–µ–∫—Ç–∞—Ö SQL.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è SQL injection
- –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ:
try:
    order_id = int(search)
    query = query.filter(Order.id == order_id)
except ValueError:
    # –ù–µ —á–∏—Å–ª–æ - –∏—â–µ–º –ø–æ –¥—Ä—É–≥–∏–º –ø–æ–ª—è–º
    pass
```

---

## üü† –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –¥–æ –¥–µ–ø–ª–æ—è)

### 6. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –≤ operator/routes.py:183-204**
**–§–∞–π–ª:** `app/operator/routes.py:183-204`
**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è `take_order` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –î–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∑—è—Ç—å –æ–¥–∏–Ω –∑–∞–∫–∞–∑.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
- –ü–æ—Ç–µ—Ä—è –¥–µ–Ω–µ–≥ –∫–æ–º–ø–∞–Ω–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
from sqlalchemy import select
stmt = select(Order).where(
    Order.id == order_id,
    Order.status == 'paid',
    Order.operator_id.is_(None)
).with_for_update()
order = db.session.scalar(stmt)
if not order:
    flash('–ó–∞–∫–∞–∑ —É–∂–µ –≤–∑—è—Ç –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º', 'error')
    return redirect(...)
```

---

### 7. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ customer dashboard**
**–§–∞–π–ª:** `app/customer/routes.py:24`
**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
Order.status.in_(['pending_payment', 'pending'])
```
–°—Ç–∞—Ç—É—Å `'pending'` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –º–æ–¥–µ–ª–∏ Order. –≠—Ç–æ –º–µ—Ä—Ç–≤—ã–π –∫–æ–¥.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
- –ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ UI

**–†–µ—à–µ–Ω–∏–µ:**
```python
Order.status.in_(['awaiting_payment', 'checkout_initiated'])
```

---

### 8. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ video_links –≤ API**
**–§–∞–π–ª:** `app/api/routes.py:490-604`
**–ü—Ä–æ–±–ª–µ–º–∞:** API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª—é–±—ã–µ —Å—Ç—Ä–æ–∫–∏ –∫–∞–∫ video_links –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ URL.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –∫–ª–∏–µ–Ω—Ç—É
- XSS –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- –§–∏—à–∏–Ω–≥ –∞—Ç–∞–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
from urllib.parse import urlparse
for key, link in video_links.items():
    parsed = urlparse(link)
    if not parsed.scheme in ['http', 'https']:
        return jsonify({'error': 'Invalid URL'}), 400
```

---

### 9. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö endpoints**
**–§–∞–π–ª:** `app/api/cloudpayments_endpoints.py:19`
**–ü—Ä–æ–±–ª–µ–º–∞:** Webhook endpoint –Ω–µ –∏–º–µ–µ—Ç rate limiting. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç —Å–ø–∞–º–∏—Ç—å webhook'–∞–º–∏.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- DoS –∞—Ç–∞–∫–∞
- –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:**
```python
from app import limiter
@limiter.limit("100 per minute")
@bp.route('/cloudpayments/webhook', methods=['POST'])
def cloudpayments_webhook():
    ...
```

---

### 10. **–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ eval/exec**
**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** –ù–µ—Ç –ø—Ä—è–º–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `eval()` –∏–ª–∏ `exec()` - ‚úÖ –•–û–†–û–®–û

---

## üü° –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å)

### 11. **N+1 –∑–∞–ø—Ä–æ—Å—ã –≤ admin/routes.py**
**–§–∞–π–ª:** `app/admin/routes.py:229-248`
**–ü—Ä–æ–±–ª–µ–º–∞:** –¶–∏–∫–ª –ø–æ events –±–µ–∑ eager loading relationships:
```python
for event in events.items:
    orders = Order.query.filter_by(event_id=event.id).all()  # N+1!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–¥–º–∏–Ω–∫–∏
- –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î

**–†–µ—à–µ–Ω–∏–µ:**
```python
from sqlalchemy import func
# –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N+1
event_stats = db.session.query(
    Order.event_id,
    func.count(Order.id).label('total'),
    func.sum(case((Order.status == 'completed', Order.total_amount), else_=0)).label('revenue')
).group_by(Order.event_id).all()
```

---

### 12. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ –≤ chat_endpoints**
**–§–∞–π–ª:** `app/api/chat_endpoints.py` (–Ω–µ –ø–æ–∫–∞–∑–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ —á–∞—Ç, –Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏—Å–∫–∞
- DoS —á–µ—Ä–µ–∑ –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã

**–†–µ—à–µ–Ω–∏–µ:**
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ `MAX_CHAT_FILE_SIZE` –∏ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ.

---

### 13. **Hardcoded –∑–Ω–∞—á–µ–Ω–∏—è –≤ operator statistics**
**–§–∞–π–ª:** `app/operator/routes.py:391-395`
**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
order_earnings += sport_count * 100  # Hardcoded!
order_earnings += tv_count * 300     # Hardcoded!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å—Ü–µ–Ω–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
- –û—à–∏–±–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
–í—ã–Ω–µ—Å—Ç–∏ –≤ SystemSettings –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥:
```python
sport_rate = get_setting_int('operator_sport_video_rate', 100)
tv_rate = get_setting_int('operator_tv_video_rate', 300)
```

---

### 14. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö**
**–§–∞–π–ª:** `app/operator/routes.py:258-330`
**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è `upload_video_links` –¥–µ–ª–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–π –±–µ–∑ —è–≤–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ:**
```python
try:
    # –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    order.video_links = video_links
    order.status = 'links_sent'
    # ... –¥—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    db.session.commit()
except Exception as e:
    db.session.rollback()
    raise
```

---

### 15. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ email –≤ telegram registration**
**–§–∞–π–ª:** `app/telegram_bot/handlers/registration.py` (–Ω–µ –ø–æ–∫–∞–∑–∞–Ω)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ª–∏ email –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ email –≤ –±–∞–∑–µ
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–∞

---

## üü¢ –ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å)

### 16. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –ø–æ–ª—É—á–µ–Ω–∏—è video_types_dict**
**–§–∞–π–ª—ã:** –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–¥ `video_types_dict = {str(vt.id): vt for vt in video_types}` –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ 10+ –º–µ—Å—Ç–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å helper —Ñ—É–Ω–∫—Ü–∏—é:
```python
# app/utils/helpers.py
def get_video_types_dict():
    video_types = VideoType.query.all()
    return {str(vt.id): vt for vt in video_types}
```

---

### 17. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è VideoType**
**–ü—Ä–æ–±–ª–µ–º–∞:** VideoType –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º request, —Ö–æ—Ç—è –º–µ–Ω—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ.

**–†–µ—à–µ–Ω–∏–µ:**
```python
from flask_caching import Cache
cache = Cache(app, config={'CACHE_TYPE': 'simple'})

@cache.memoize(timeout=300)  # 5 –º–∏–Ω—É—Ç
def get_video_types():
    return VideoType.query.all()
```

---

### 18. **–ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ statistics**
**–§–∞–π–ª:** `app/operator/routes.py:332-435`
**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤ Python, –∞ –Ω–µ –≤ SQL.

**–†–µ—à–µ–Ω–∏–µ:**
–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–∞ SQL –∞–≥—Ä–µ–≥–∞—Ü–∏—é –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è.

---

### 19. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö**
**–§–∞–π–ª—ã:** –†–∞–∑–ª–∏—á–Ω—ã–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤).

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤.

---

### 20. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –º–µ—Ç—Ä–∏–∫**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Prometheus/Grafana –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å prometheus_flask_exporter:
```python
from prometheus_flask_exporter import PrometheusMetrics
metrics = PrometheusMetrics(app)
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ê–£–î–ò–¢–ê

- **–í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:** 25+
- **–ù–∞–π–¥–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º:** 5
- **–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º –≤—ã—Å–æ–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞:** 5
- **–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞:** 5
- **–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º –Ω–∏–∑–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞:** 5
- **–í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º:** 20

---

## ‚úÖ –ß–¢–û –°–î–ï–õ–ê–ù–û –•–û–†–û–®–û

1. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `with_for_update()` –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö (—Ö–æ—Ç—è –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
2. ‚úÖ Eager loading relationships –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –º–µ—Å—Ç
3. ‚úÖ Audit logging –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook CloudPayments
5. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ environment variables –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
6. ‚úÖ Retry logic –¥–ª—è database locked errors
7. ‚úÖ –ù–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è eval/exec
8. ‚úÖ CSRF –∑–∞—â–∏—Ç–∞ –≤–∫–ª—é—á–µ–Ω–∞
9. ‚úÖ –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ werkzeug
10. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ prepared statements (SQLAlchemy ORM)

---

## üöÄ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–ï–†–ï–î –î–ï–ü–õ–û–ï–ú

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:
1. ‚ùó Race condition –≤ webhook (–ø—Ä–æ–±–ª–µ–º–∞ #1)
2. ‚ùó –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã (–ø—Ä–æ–±–ª–µ–º–∞ #2)
3. ‚ùó –£–±—Ä–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–æ–±–ª–µ–º–∞ #3)
4. ‚ùó Race condition –≤ take_order (–ø—Ä–æ–±–ª–µ–º–∞ #6)
5. ‚ùó –î–æ–±–∞–≤–∏—Ç—å rate limiting –Ω–∞ webhook (–ø—Ä–æ–±–ª–µ–º–∞ #9)

### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:
6. ‚ö†Ô∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –≤ customer dashboard (–ø—Ä–æ–±–ª–µ–º–∞ #7)
7. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é video_links (–ø—Ä–æ–±–ª–µ–º–∞ #8)
8. ‚ö†Ô∏è –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å N+1 –∑–∞–ø—Ä–æ—Å—ã (–ø—Ä–æ–±–ª–µ–º–∞ #11)

### –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
9. üìù –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
10. üìù –î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
11. üìù –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞

---

## üìù –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å HTTPS (SSL/TLS) –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS
- –í–∫–ª—é—á–∏—Ç—å CSP (Content Security Policy)
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å fail2ban –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å connection pooling –¥–ª—è PostgreSQL (–µ—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ —Å SQLite)
- –í–∫–ª—é—á–∏—Ç—å Redis –¥–ª—è —Å–µ—Å—Å–∏–π –∏ –∫–µ—à–∞
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CDN –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Sentry –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ ELK/Loki
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

---

**–ê—É–¥–∏—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω:** AI Code Reviewer
**–î–∞—Ç–∞:** 2025-11-07
**–°–ª–µ–¥—É—é—â–∏–π –∞—É–¥–∏—Ç:** –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

