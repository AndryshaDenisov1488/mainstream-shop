# –ü–æ–ª–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞ MainStream Shop

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:** 2024-11-14  
**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω

## –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∞—É–¥–∏—Ç–∞

–ü—Ä–æ–≤–µ—Ä–µ–Ω—ã:
1. ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–ø–∞—Ä–æ–ª–∏, —Ç–æ–∫–µ–Ω—ã, SQL injection, XSS)
2. ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (N+1 –∑–∞–ø—Ä–æ—Å—ã, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ë–î)
3. ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∫–æ–¥–∞
4. ‚úÖ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏
5. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
6. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
7. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è LOGIN –≤ auth/routes.py**
**–§–∞–π–ª:** `app/auth/routes.py:62-90`

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã:
- –°—Ç—Ä–æ–∫–∞ 62: `AuditLog.create_log(action='LOGIN', ...)`  
- –°—Ç—Ä–æ–∫–∞ 84: `AuditLog.log_user_action(action='LOGIN', ...)`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –≤ audit_logs
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ë–î
- –ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ –ª–æ–≥–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –£–¥–∞–ª–∏—Ç—å –æ–¥–Ω–æ –∏–∑ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–π
# –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ:
AuditLog.log_user_action(
    user_id=user.id,
    action='LOGIN',
    ip_address=request.remote_addr,
    user_agent=request.headers.get('User-Agent'),
    details={'remember_me': form.remember_me.data}
)
```

---

### 2. **N+1 –∑–∞–ø—Ä–æ—Å—ã –≤ main/routes.py**
**–§–∞–π–ª:** `app/main/routes.py:66-67`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
for category in categories:
    category.athletes_count = Athlete.query.filter_by(category_id=category.id).count()  # N+1!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü—Ä–∏ 10 –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö = 11 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î –≤–º–µ—Å—Ç–æ 2
- –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç—É—Ä–Ω–∏—Ä–∞
- –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î

**–†–µ—à–µ–Ω–∏–µ:**
```python
from sqlalchemy import func

# –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
category_stats = db.session.query(
    Category.id,
    func.count(Athlete.id).label('athletes_count')
).join(Athlete, Category.id == Athlete.category_id)\
 .filter(Category.event_id == event_id)\
 .group_by(Category.id).all()

# –°–æ–∑–¥–∞—Ç—å —Å–ª–æ–≤–∞—Ä—å
stats_dict = {cat_id: count for cat_id, count in category_stats}

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
for category in categories:
    category.athletes_count = stats_dict.get(category.id, 0)
```

---

### 3. **N+1 –∑–∞–ø—Ä–æ—Å—ã –≤ admin/routes.py –∏ mom/routes.py**
**–§–∞–π–ª:** `app/admin/routes.py:238-239`, `app/mom/routes.py:203-204`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
for event in events.items:
    orders = Order.query.filter_by(event_id=event.id).all()  # N+1!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü—Ä–∏ 20 —Ç—É—Ä–Ω–∏—Ä–∞—Ö = 21 –∑–∞–ø—Ä–æ—Å –∫ –ë–î –≤–º–µ—Å—Ç–æ 1
- –û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î

**–†–µ—à–µ–Ω–∏–µ:**
```python
from sqlalchemy import func, case

# –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤
event_stats = db.session.query(
    Order.event_id,
    func.count(Order.id).label('total_orders'),
    func.sum(case((Order.status.in_(['checkout_initiated', 'awaiting_payment']), 1), else_=0)).label('pending_orders'),
    func.sum(case((Order.status == 'processing', 1), else_=0)).label('processing_orders'),
    func.sum(case((Order.status == 'completed', Order.total_amount), else_=0)).label('total_revenue')
).group_by(Order.event_id).all()

# –°–æ–∑–¥–∞—Ç—å —Å–ª–æ–≤–∞—Ä—å
stats_dict = {event_id: {
    'total_orders': total,
    'pending_orders': pending,
    'processing_orders': processing,
    'total_revenue': revenue
} for event_id, total, pending, processing, revenue in event_stats}

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —Å–æ–±—ã—Ç–∏—è–º
for event in events.items:
    event_stats[event.id] = stats_dict.get(event.id, {...})
```

---

## üü† –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢

### 4. **Bare except –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö**
**–§–∞–π–ª—ã:** `app/models.py:78`, `app/auth/forms.py:60`, `app/telegram_bot/runner.py:81,101,115`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `except:` –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Ç–∏–ø–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è - –ø–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ú–æ–∂–µ—Ç —Å–∫—Ä—ã—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
- –°–ª–æ–∂–Ω–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ë–´–õ–û:
except:
    return None

# –î–û–õ–ñ–ù–û –ë–´–¢–¨:
except (ValueError, KeyError, jwt.DecodeError, jwt.ExpiredSignatureError) as e:
    logger.debug(f'Token verification failed: {e}')
    return None
```

---

### 5. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ retry –ª–æ–≥–∏–∫–∏ –¥–ª—è auth –æ–ø–µ—Ä–∞—Ü–∏–π**
**–§–∞–π–ª:** `app/auth/routes.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ `db.session.commit()` –≤ auth/routes.py –±–µ–∑ retry –ª–æ–≥–∏–∫–∏.

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Ä–µ–¥–∫–∏–µ (–Ω–µ —Ç–∞–∫ —á–∞—Å—Ç–æ, –∫–∞–∫ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∑–∞–∫–∞–∑–∞–º–∏). –ù–æ –±—ã–ª–æ –±—ã —Ö–æ—Ä–æ—à–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.

---

### 6. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –≤ main/routes.py**
**–§–∞–π–ª:** `app/main/routes.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ—Ä–∑–∏–Ω—ã –∏ –ø–æ–¥—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è:
- `cart()` (—Å—Ç—Ä–æ–∫–∞ 193-226)
- `checkout()` (—Å—Ç—Ä–æ–∫–∞ 323-363)

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é:
```python
def _parse_cart_items(cart):
    """Parse cart items and calculate totals"""
    cart_items = []
    total_price = 0
    
    for item_id, quantity in cart.items():
        try:
            athlete_id, video_type_id = map(int, item_id.split('_'))
            athlete = Athlete.query.get(athlete_id)
            video_type = VideoType.query.get(video_type_id)
            
            if athlete and video_type:
                item_total = video_type.price * quantity
                total_price += item_total
                
                cart_items.append({
                    'id': item_id,
                    'athlete': athlete,
                    'video_type': video_type,
                    'quantity': quantity,
                    'total': item_total
                })
        except (ValueError, AttributeError):
            continue
    
    return cart_items, total_price
```

---

## üü¢ –ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ / –£–õ–£–ß–®–ï–ù–ò–Ø

### 7. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è video_types**
**–§–∞–π–ª:** `app/main/routes.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–ø—Ä–æ—Å `VideoType.query.filter_by(is_active=True).all()` –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö.

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–Ω–µ—Å—Ç–∏ –≤ –∫—ç—à –∏–ª–∏ context processor.

---

### 8. **–•–∞—Ä–¥–∫–æ–¥ –∑–Ω–∞—á–µ–Ω–∏–π –≤ operator statistics**
**–§–∞–π–ª:** `app/operator/routes.py:498-523`

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–æ–∏–º–æ—Å—Ç—å –≤–∏–¥–µ–æ —Ç–∏–ø–æ–≤ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—Å—è –≤ –∫–æ–¥–µ:
```python
order_earnings += sport_count * 100  # Hardcoded!
order_earnings += tv_count * 300     # Hardcoded!
```

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–Ω–µ—Å—Ç–∏ –≤ SystemSettings –∏–ª–∏ VideoType.price.

---

### 9. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö**
**–§–∞–π–ª:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `MAX_CHAT_FILE_SIZE` –∏ `MAX_CONTENT_LENGTH`.

---

## ‚úÖ –£–ñ–ï –ò–°–ü–†–ê–í–õ–ï–ù–û / –•–û–†–û–®–ò–ï –ü–†–ê–ö–¢–ò–ö–ò

### 10. ‚úÖ **Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∑–∞–∫–∞–∑–∞–º–∏**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ retry –ª–æ–≥–∏–∫–∞ –¥–ª—è `database is locked` –≤–æ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
- ‚úÖ Email –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ü–û–°–õ–ï –∫–æ–º–º–∏—Ç–∞ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ë–î)
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

### 11. ‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SQLAlchemy ORM**
- ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç ORM (–∑–∞—â–∏—Ç–∞ –æ—Ç SQL injection)
- ‚úÖ –ù–µ—Ç raw SQL —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å—Ç—Ä–æ–∫

### 12. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ CloudPayments**
- ‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ webhook
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

### 13. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
- ‚úÖ –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ DEBUG —É—Ä–æ–≤–Ω–µ
- ‚úÖ Audit log –¥–ª—è –≤–∞–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### 14. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
- ‚úÖ WTForms –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –∏ email

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ù–ê–ô–î–ï–ù–ù–´–• –ü–†–û–ë–õ–ï–ú

- **üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã—Ö:** 3
- **üü† –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** 3
- **üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** 3
- **‚úÖ –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 5

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ü–†–ò–û–†–ò–¢–ï–¢–ê–ú

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å (üî¥):
1. –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è LOGIN
2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –∑–∞–ø—Ä–æ—Å—ã –≤ main/routes.py
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –∑–∞–ø—Ä–æ—Å—ã –≤ admin/routes.py –∏ mom/routes.py

### –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è (üü†):
4. –ó–∞–º–µ–Ω–∏—Ç—å bare except –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∏–ø—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π
5. –î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É –¥–ª—è auth –æ–ø–µ—Ä–∞—Ü–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
6. –í—ã–Ω–µ—Å—Ç–∏ –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –∫–æ–¥ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ—Ä–∑–∏–Ω—ã

### –£–ª—É—á—à–µ–Ω–∏—è (üü¢):
7. –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å video_types
8. –í—ã–Ω–µ—Å—Ç–∏ —Ö–∞—Ä–¥–∫–æ–¥ –∑–Ω–∞—á–µ–Ω–∏–π –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
9. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –≤–µ–∑–¥–µ

---

---

## üî¥ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (–≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑)

### 10. **Race Condition –≤ take_order –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**
**–§–∞–π–ª:** `app/operator/routes.py:250-294`

**–ü—Ä–æ–±–ª–µ–º–∞:** 
```python
order = Order.query.get_or_404(order_id)  # ‚ùå –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏!
if order.status != 'paid':
    return redirect(...)

order.status = 'processing'
order.operator_id = current_user.id
db.session.commit()  # ‚ùå –î–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∑—è—Ç—å –æ–¥–∏–Ω –∑–∞–∫–∞–∑
```

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ:** –í `app/api/routes.py:757-762` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞:
```python
stmt = select(Order).where(
    Order.id == order_id,
    Order.status == 'paid',
    Order.operator_id.is_(None)
).with_for_update()  # ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –î–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∑—è—Ç—å –æ–¥–∏–Ω –∑–∞–∫–∞–∑
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
- –ü–æ—Ç–µ—Ä—è –¥–µ–Ω–µ–≥ –∫–æ–º–ø–∞–Ω–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
from sqlalchemy import select

stmt = select(Order).where(
    Order.id == order_id,
    Order.status == 'paid',
    Order.operator_id.is_(None)  # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
).with_for_update()

order = db.session.scalar(stmt)
if not order:
    flash('–ó–∞–∫–∞–∑ —É–∂–µ –≤–∑—è—Ç –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º', 'error')
    return redirect(url_for('operator.new_orders'))

order.status = 'processing'
order.operator_id = current_user.id
db.session.commit()
```

---

### 11. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ operator_change_order_status**
**–§–∞–π–ª:** `app/api/routes.py:381`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
valid_statuses = ['draft', 'checkout_initiated', 'awaiting_payment', ...]  # ‚ùå –•–∞—Ä–¥–∫–æ–¥!
```

–£–∂–µ –µ—Å—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `OPERATOR_MANAGEABLE_STATUSES`, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ö–∞—Ä–¥–∫–æ–¥.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å—Ç–∞—Ç—É—Å–æ–≤
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö)
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –æ–±—â—É—é
ALL_STATUSES = tuple(STATUS_ORDER)  # –ò–∑ app/utils/order_status.py

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É
if new_status not in OPERATOR_MANAGEABLE_STATUSES:
    # –ù–æ —ç—Ç–æ –Ω–µ –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã, –Ω—É–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å ALL_STATUSES
```

---

### 12. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤**
**–§–∞–π–ª:** `app/api/routes.py:274-289`, `app/operator/routes.py:263`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –∏–∑ –ª—é–±–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –≤ –ª—é–±–æ–π, –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞.

**–ü—Ä–∏–º–µ—Ä –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞:**
```python
order.status = 'completed'  # –ò–∑ 'draft' –≤ 'completed' - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–∞—Ä—É—à–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–∫–∞–∑–∞
- –ü—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å—é

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
STATUS_TRANSITIONS = {
    'draft': ['checkout_initiated', 'cancelled_unpaid'],
    'checkout_initiated': ['awaiting_payment', 'cancelled_unpaid'],
    'awaiting_payment': ['paid', 'cancelled_unpaid'],
    'paid': ['processing', 'cancelled_manual'],
    'processing': ['awaiting_info', 'ready', 'cancelled_manual'],
    'awaiting_info': ['processing', 'cancelled_manual'],
    'ready': ['links_sent', 'cancelled_manual'],
    'links_sent': ['completed', 'refund_required', 'cancelled_manual'],
    'completed': ['completed_partial_refund', 'refund_required'],
    'refund_required': ['completed_partial_refund', 'refunded_full', 'refunded_partial'],
    # –§–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã - –ø–µ—Ä–µ—Ö–æ–¥—ã –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã
    'completed_partial_refund': [],
    'refunded_full': [],
    'refunded_partial': [],
    'cancelled_unpaid': [],
    'cancelled_manual': [],
}

def is_valid_status_transition(old_status: str, new_status: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞ —Å—Ç–∞—Ç—É—Å–∞"""
    if old_status == new_status:
        return True  # –û—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π - OK
    
    allowed_transitions = STATUS_TRANSITIONS.get(old_status, [])
    return new_status in allowed_transitions

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
if not is_valid_status_transition(order.status, new_status):
    return jsonify({
        'success': False, 
        'error': f'–ù–µ–≤–æ–∑–º–æ–∂–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥ –∏–∑ —Å—Ç–∞—Ç—É—Å–∞ {order.status} –≤ {new_status}'
    }), 400
```

---

### 13. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ .cast() —Å .contains() –≤ –ø–æ–∏—Å–∫–µ**
**–§–∞–π–ª:** `app/operator/routes.py:77`, `app/mom/routes.py:82`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
(Order.id.cast(db.String).contains(search))
```

–•–æ—Ç—è SQLAlchemy —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `cast` —Å `contains` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–º –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
- –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ë–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ:
try:
    order_id = int(search)
    query = query.filter(Order.id == order_id)
except ValueError:
    # –ù–µ —á–∏—Å–ª–æ - –∏—â–µ–º –ø–æ –¥—Ä—É–≥–∏–º –ø–æ–ª—è–º
    pass
```

---

### 14. **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ error messages**
**–§–∞–π–ª:** –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –º–µ—Å—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø–æ–ª–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
```python
return jsonify({'success': False, 'error': str(e)}), 500  # ‚ùå –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –†–∞—Å–∫—Ä—ã—Ç–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í production:
if current_app.config.get('DEBUG'):
    error_msg = str(e)
else:
    error_msg = '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'

return jsonify({'success': False, 'error': error_msg}), 500
```

---

### 15. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö**
**–§–∞–π–ª:** `app/api/routes.py:741-743`

**–ü—Ä–æ–±–ª–µ–º–∞:** `assign_operator_api` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞, –Ω–æ –ª–æ–≥–∏–∫–∞ —Å–ª–æ–∂–Ω–∞—è:
```python
if not (current_user.role == 'ADMIN' or current_user.role == 'MOM' or current_user.role == 'OPERATOR'):
```

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä:
```python
@role_required('ADMIN', 'MOM', 'OPERATOR')  # ‚úÖ –ü—Ä–æ—â–µ –∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ
```

---

### 16. **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –≤ upload_video_links**
**–§–∞–π–ª:** `app/operator/routes.py:411-412`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
if not order.operator_id:
    order.operator_id = current_user.id  # ‚ùå –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏!
```

–î–≤–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–±—è –∫–∞–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `with_for_update()` –∫–∞–∫ –≤ `assign_operator_api`.

---

### 17. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ retry –≤ –∫–∞–∂–¥–æ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ**
**–§–∞–π–ª:** –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –º–µ—Å—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** Retry –ª–æ–≥–∏–∫–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º –º–µ—Å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `_execute_db_operation_with_retry`:
```python
# –í–º–µ—Å—Ç–æ:
for attempt in range(max_retries):
    try:
        db.session.commit()
        break
    except OperationalError as e:
        # ... retry logic

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
_execute_db_operation_with_retry(
    lambda: None,  # –û–ø–µ—Ä–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ
    context='change_order_status'
)
```

---

## üìä –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ù–ê–ô–î–ï–ù–ù–´–• –ü–†–û–ë–õ–ï–ú

- **üî¥ –ö—Ä–∏—Ç–∏—á–Ω—ã—Ö:** 6 (–±—ã–ª–æ 3)
- **üü† –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** 6 (–±—ã–ª–æ 3)
- **üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** 5 (–±—ã–ª–æ 3)
- **‚úÖ –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 5

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–ü–æ—Å–ª–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ **17 –ø—Ä–æ–±–ª–µ–º**, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö **6 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö** —Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–±–ª–µ–º:**
1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** (N+1 –∑–∞–ø—Ä–æ—Å—ã) - 3 –ø—Ä–æ–±–ª–µ–º—ã
2. **Race conditions** (–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫) - 2 –ø—Ä–æ–±–ª–µ–º—ã
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** (—Å—Ç–∞—Ç—É—Å—ã, –ø–µ—Ä–µ—Ö–æ–¥—ã) - 3 –ø—Ä–æ–±–ª–µ–º—ã
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** (—É—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞) - 2 –ø—Ä–æ–±–ª–µ–º—ã
5. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞** - 4 –ø—Ä–æ–±–ª–µ–º—ã
6. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - 3 –ø—Ä–æ–±–ª–µ–º—ã

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å race conditions (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)
2. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2)
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3)
4. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4)

---

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 2024-11-14  
**–í—ã–ø–æ–ª–Ω–∏–ª:** Auto (Cursor AI Assistant)  
**–í–µ—Ä—Å–∏—è –æ—Ç—á–µ—Ç–∞:** 2.0 (–≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑)
