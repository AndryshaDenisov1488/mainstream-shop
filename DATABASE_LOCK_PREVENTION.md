# –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ "database is locked" –≤ SQLite

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

1. **Retry –ª–æ–≥–∏–∫–∞ —Å exponential backoff** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
2. **WAL mode (Write-Ahead Logging)** - –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∏—Ç–∞—Ç–µ–ª–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
3. **–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π busy_timeout** - –¥–æ 10 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 5

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

### 1. –î–µ–ª–∞–π—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏

**‚ùå –ü–ª–æ—Ö–æ:**
```python
# –î–æ–ª–≥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ –≤—ã–∑–æ–≤–∞–º–∏
db.session.add(order)
send_email()  # –ú–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
db.session.commit()  # –ë–∞–∑–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –≤—Å–µ —ç—Ç–æ –≤—Ä–µ–º—è
```

**‚úÖ –•–æ—Ä–æ—à–æ:**
```python
# –ö–æ—Ä–æ—Ç–∫–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è, –≤–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã –ø–æ—Å–ª–µ commit
db.session.add(order)
db.session.commit()  # –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
send_email()  # –ü–æ—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º email
```

### 2. –ö–æ–º–º–∏—Ç—å—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–∞–∫ –º–æ–∂–Ω–æ —Ä–∞–Ω—å—à–µ

**‚ùå –ü–ª–æ—Ö–æ:**
```python
order = Order(...)
db.session.add(order)
# –ú–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π...
payment = Payment(...)
db.session.add(payment)
# –ï—â–µ –æ–ø–µ—Ä–∞—Ü–∏–∏...
db.session.commit()  # –í—Å–µ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```

**‚úÖ –•–æ—Ä–æ—à–æ:**
```python
order = Order(...)
db.session.add(order)
db.session.commit()  # –ö–æ–º–º–∏—Ç–∏–º –∑–∞–∫–∞–∑ —Å—Ä–∞–∑—É

payment = Payment(...)
db.session.add(payment)
db.session.commit()  # –ö–æ–º–º–∏—Ç–∏–º –ø–ª–∞—Ç–µ–∂ –æ—Ç–¥–µ–ª—å–Ω–æ
```

### 3. –ò–∑–±–µ–≥–∞–π—Ç–µ –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–ù–µ –¥–µ–ª–∞–π—Ç–µ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:**
- HTTP –∑–∞–ø—Ä–æ—Å—ã (API –≤—ã–∑–æ–≤—ã)
- –û—Ç–ø—Ä–∞–≤–∫–∞ email
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
- –°–ª–æ–∂–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
- –û–∂–∏–¥–∞–Ω–∏–µ (sleep, time.sleep)

**‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫:**
```python
# 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
data = prepare_data()

# 2. –ö–æ—Ä–æ—Ç–∫–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
db.session.add(order)
db.session.commit()

# 3. –í–Ω–µ—à–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–æ—Å–ª–µ commit)
send_email()
make_api_call()
```

### 4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

**‚úÖ –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ try/except —Å rollback:**
```python
try:
    db.session.add(order)
    db.session.commit()
except Exception as e:
    db.session.rollback()  # –í–∞–∂–Ω–æ!
    logger.error(f'Error: {e}')
    raise
```

### 5. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ PostgreSQL

**SQLite –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –û–¥–∏–Ω writer –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å—é –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**PostgreSQL –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ writers
- –õ—É—á—à–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### 6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ retry
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ "database is locked"

**–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- –ú–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞—Ö
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ retry –ø–æ–ø—ã—Ç–æ–∫

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –ú–µ—Å—Ç–∞, —Ç—Ä–µ–±—É—é—â–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è:

1. **`app/main/payment_routes.py`** - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
   - ‚úÖ –£–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å retry –ª–æ–≥–∏–∫–æ–π
   - ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–æ—Ä–æ—Ç–∫–∏–µ

2. **`app/telegram_bot/bot_manager.py`** - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ –±–æ—Ç–∞
   - ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ—Ç –ª–∏ –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ—Å–ª–µ commit

3. **`app/api/cloudpayments_endpoints.py`** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook
   - ‚ö†Ô∏è –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–æ—Ä–æ—Ç–∫–∏–µ

4. **`app/tasks/order_cleanup.py`** - —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
   - ‚úÖ –ö–∞–∂–¥—ã–π –∑–∞–∫–∞–∑ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ SQLite:

1. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
   - SQLite —Ö–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–æ ~100 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ü—Ä–∏ –±–æ–ª—å—à–µ–π –Ω–∞–≥—Ä—É–∑–∫–µ - –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ PostgreSQL

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**
   - –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ "database is locked"
   - –ï—Å–ª–∏ —á–∞—Å—Ç–æ - –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ PostgreSQL

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω–¥–µ–∫—Å—ã
   - –ò–∑–±–µ–≥–∞–π—Ç–µ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `joinedload` –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –ï—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ PostgreSQL:

1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ**
   - SQLAlchemy –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ –¥–≤–∏–∂–∫–∞
   - –ù—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å `DATABASE_URL`

2. **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ writers
   - –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
   - –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π

## üìä –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**SQLite –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è):**
- WAL mode: –≤–∫–ª—é—á–µ–Ω
- busy_timeout: 10000ms (10 —Å–µ–∫—É–Ω–¥)
- Foreign keys: –≤–∫–ª—é—á–µ–Ω—ã

**Retry –ª–æ–≥–∏–∫–∞:**
- –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫: 5
- –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 100ms
- Exponential backoff: –¥–∞
- –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: –¥–∞

## ‚ö†Ô∏è –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞—Ö

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** - –Ω–∞–π–¥–∏—Ç–µ –º–µ—Å—Ç–∞ —Å –¥–æ–ª–≥–∏–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ–¥** - —Å–¥–µ–ª–∞–π—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–æ—Ä–æ—á–µ
3. **–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ PostgreSQL** - –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Å –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –¥–æ–±–∞–≤—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## üìù –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞ —Å –ë–î:

- [ ] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∫–æ—Ä–æ—Ç–∫–∞—è (< 1 —Å–µ–∫—É–Ω–¥—ã)
- [ ] –ù–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- [ ] –ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ email –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- [ ] –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- [ ] –ï—Å—Ç—å try/except —Å rollback
- [ ] Commit –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∫ –º–æ–∂–Ω–æ —Ä–∞–Ω—å—à–µ
- [ ] –í–Ω–µ—à–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ commit

