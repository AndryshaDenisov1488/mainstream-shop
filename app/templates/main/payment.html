{% extends "base.html" %}

{% block title %}–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i>
                        –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ {{ order.generated_order_number }}
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Order Summary -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞:</h6>
                            <p><strong>–°–ø–æ—Ä—Ç—Å–º–µ–Ω:</strong> {{ order.athlete.name }}</p>
                            <p><strong>–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ:</strong> {{ order.event.name }}</p>
                            <p><strong>–¢–∏–ø—ã –≤–∏–¥–µ–æ:</strong> 
                                {% for video_type_id in order.video_types %}
                                    {% set video_type = video_types.get(video_type_id) %}
                                    {% if video_type %}{{ video_type.name }}{% if not loop.last %}, {% endif %}{% endif %}
                                {% endfor %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ:</h6>
                            <div class="h4 text-primary">
                                {{ "%.2f"|format(order.total_amount) }} RUB
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method Selection -->
                    <!-- Payment Buttons -->
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-primary btn-lg" onclick="initiatePayment()">
                            <i class="fas fa-credit-card me-2"></i>
                            –û–ø–ª–∞—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ–π {{ "%.2f"|format(order.total_amount) }} RUB
                        </button>
                        
                        <button type="button" class="btn btn-success btn-lg" onclick="initiateSbpPayment()">
                            <i class="fas fa-mobile-alt me-2"></i>
                            –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –°–ë–ü {{ "%.2f"|format(order.total_amount) }} RUB
                        </button>
                    </div>

                    <!-- Payment Status -->
                    <div id="paymentStatus" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            <span id="statusText">–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...</span>
                        </div>
                    </div>

                    <!-- Back to Cart -->
                    <div class="mt-4 text-center">
                        <a href="{{ url_for('main.cart') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–æ—Ä–∑–∏–Ω—É
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CloudPayments Widget Script -->
<script src="https://widget.cloudpayments.ru/bundles/cloudpayments.js"></script>

<!-- Payment data from server -->
<script type="application/json" id="payment-data">
{% if payment_data %}{{ payment_data | tojson | safe }}{% else %}null{% endif %}
</script>

<script>
// Get payment data from JSON script tag
var paymentData;
try {
    paymentData = JSON.parse(document.getElementById('payment-data').textContent);
} catch (e) {
    console.error('Error parsing payment data:', e);
    paymentData = null;
}

var orderId = parseInt('{{ order.id }}');
var paymentMethod = '{{ payment_method|default("card") }}';

// Check if payment data is valid
if (!paymentData || !paymentData.publicId) {
    console.error('Payment data is not available:', paymentData);
    const paymentContainer = document.querySelector('.card-body');
    if (paymentContainer) {
        paymentContainer.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h5>
                <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</p>
                <ul>
                    <li>–ó–∞–∫–∞–∑ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∏–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω</li>
                    <li>–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ</li>
                    <li>–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã</li>
                </ul>
                <p class="mb-0">
                    <a href="{{ url_for('main.index') }}" class="btn btn-primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
                    <a href="mailto:support@mainstreamfs.ru" class="btn btn-outline-secondary">–°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</a>
                </p>
            </div>
        `;
    }
}

// Payment functions

function showPaymentStatus(text) {
    document.getElementById('statusText').textContent = text;
    document.getElementById('paymentStatus').style.display = 'block';
}

function hidePaymentStatus() {
    document.getElementById('paymentStatus').style.display = 'none';
}

function initiatePayment() {
    // Check if CloudPayments is loaded
    if (typeof cp === 'undefined') {
        alert('CloudPayments –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        return;
    }
    
    // Check payment data
    if (!paymentData || !paymentData.publicId) {
        alert('–û—à–∏–±–∫–∞: –ø–ª–∞—Ç–µ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        return;
    }
    
    showPaymentStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞...');
    
    // Disable buttons
    const cardBtn = document.querySelector('button[onclick="initiatePayment()"]');
    const sbpBtn = document.querySelector('button[onclick="initiateSbpPayment()"]');
    if (cardBtn) cardBtn.disabled = true;
    if (sbpBtn) sbpBtn.disabled = true;
    
    // Create CloudPayments widget
    const widget = new cp.CloudPayments();
    
    // Payment parameters for card payment
    const paymentParams = {
        publicId: paymentData.publicId,
        description: paymentData.description,
        amount: paymentData.amount,
        currency: paymentData.currency,
        invoiceId: paymentData.invoiceId,
        email: paymentData.email
    };
    
    // Add optional fields if they exist
    if (paymentData.accountId) {
        paymentParams.accountId = paymentData.accountId;
    }
    if (paymentData.jsonData) {
        paymentParams.data = paymentData.jsonData;
    }
    
    console.log('üîç Initiating card payment with params:', paymentParams);
    
    // Use correct CloudPayments API method
    widget.pay('charge', paymentParams, {
        onSuccess: function (options) {
            console.log('Payment success:', options);
            showPaymentStatus('–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
            // Redirect to success page
            setTimeout(function() {
                window.location.href = '/order-success/' + orderId;
            }, 1500);
        },
        onFail: function (reason, options) {
            console.error('Payment failed:', reason, options);
            let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            if (reason) {
                if (typeof reason === 'string') {
                    errorMessage = reason;
                } else if (reason.message) {
                    errorMessage = reason.message;
                } else if (reason.description) {
                    errorMessage = reason.description;
                }
            }
            showPaymentStatus('–û—à–∏–±–∫–∞: ' + errorMessage);
            // Re-enable buttons
            if (cardBtn) cardBtn.disabled = false;
            if (sbpBtn) sbpBtn.disabled = false;
        }
    });
}

function initiateSbpPayment() {
    // Check if CloudPayments is loaded
    if (typeof cp === 'undefined') {
        alert('CloudPayments –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        return;
    }
    
    // Check payment data
    if (!paymentData || !paymentData.publicId) {
        alert('–û—à–∏–±–∫–∞: –ø–ª–∞—Ç–µ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        return;
    }
    
    showPaymentStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –°–ë–ü –ø–ª–∞—Ç–µ–∂–∞...');
    
    // Disable buttons
    const cardBtn = document.querySelector('button[onclick="initiatePayment()"]');
    const sbpBtn = document.querySelector('button[onclick="initiateSbpPayment()"]');
    if (cardBtn) cardBtn.disabled = true;
    if (sbpBtn) sbpBtn.disabled = true;
    
    // Create CloudPayments widget for SBP
    const widget = new cp.CloudPayments();
    
    // Payment parameters for SBP payment
    const paymentParams = {
        publicId: paymentData.publicId,
        description: paymentData.description,
        amount: paymentData.amount,
        currency: paymentData.currency,
        invoiceId: paymentData.invoiceId,
        email: paymentData.email,
        paymentMethod: 'sbp'
    };
    
    // Add optional fields if they exist
    if (paymentData.accountId) {
        paymentParams.accountId = paymentData.accountId;
    }
    if (paymentData.jsonData) {
        paymentParams.data = paymentData.jsonData;
    }
    
    console.log('üîç Initiating SBP payment with params:', paymentParams);
    
    // Use correct CloudPayments API method
    widget.pay('charge', paymentParams, {
        onSuccess: function (options) {
            console.log('SBP payment success:', options);
            showPaymentStatus('–°–ë–ü –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
            // Redirect to success page
            setTimeout(function() {
                window.location.href = '/order-success/' + orderId;
            }, 1500);
        },
        onFail: function (reason, options) {
            console.error('SBP payment failed:', reason, options);
            let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            if (reason) {
                if (typeof reason === 'string') {
                    errorMessage = reason;
                } else if (reason.message) {
                    errorMessage = reason.message;
                } else if (reason.description) {
                    errorMessage = reason.description;
                }
            }
            showPaymentStatus('–û—à–∏–±–∫–∞: ' + errorMessage);
            // Re-enable buttons
            if (cardBtn) cardBtn.disabled = false;
            if (sbpBtn) sbpBtn.disabled = false;
        }
    });
}
</script>
{% endblock %}
