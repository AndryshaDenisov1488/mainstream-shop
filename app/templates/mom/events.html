{% extends "base.html" %}

{% block title %}–¢—É—Ä–Ω–∏—Ä—ã - MainStream Shop{% endblock %}

{% block content %}
<div class="container-fluid layout-wide py-5">
    <!-- Page Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">–¢—É—Ä–Ω–∏—Ä—ã</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('mom.dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –¥–∞—à–±–æ—Ä–¥—É
            </a>
        </div>
    </div>

    <!-- Events Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">–í—Å–µ —Ç—É—Ä–Ω–∏—Ä—ã ({{ events.total }} –Ω–∞–π–¥–µ–Ω–æ)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–ú–µ—Å—Ç–æ</th>
                            <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
                            <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</th>
                            <th>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if events.items %}
                            {% for event in events.items %}
                            {% set stats = event_stats.get(event.id, {}) %}
                            <tr>
                                <td>
                                    <strong>{{ event.name }}</strong>
                                    <br>
                                    <button class="btn btn-sm btn-outline-info mt-1" type="button" data-bs-toggle="collapse" data-bs-target="#eventStats{{ event.id }}" aria-expanded="false">
                                        <i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                                    </button>
                                </td>
                                <td>{{ event.place or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                                <td>{{ event.start_date.strftime('%d.%m.%Y') if event.start_date else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                                <td>{{ event.end_date.strftime('%d.%m.%Y') if event.end_date else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if event.is_active else 'secondary' }}">
                                        {{ '–ê–∫—Ç–∏–≤–µ–Ω' if event.is_active else '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' }}
                                    </span>
                                </td>
                                <td>{{ event.categories.count() if event.categories else 0 }}</td>
                                <td>
                                    <div class="row g-1">
                                        <div class="col-12">
                                            <span class="badge bg-primary">{{ stats.get('total_orders', 0) }} –≤—Å–µ–≥–æ</span>
                                        </div>
                                        <div class="col-6">
                                            <span class="badge bg-success">{{ stats.get('completed_orders', 0) }} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                                        </div>
                                        <div class="col-6">
                                            <span class="badge bg-warning">{{ stats.get('refund_required_orders', 0) }} –≤–æ–∑–≤—Ä–∞—Ç</span>
                                        </div>
                                        <div class="col-12 mt-1">
                                            <small class="text-success">üí∞ {{ "%.0f"|format(stats.get('total_revenue', 0)) }} ‚ÇΩ</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <a href="{{ url_for('mom.event_detail', event_id=event.id) }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            <!-- Expandable statistics row -->
                            <tr class="collapse" id="eventStats{{ event.id }}">
                                <td colspan="8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">üìä –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {{ event.name }}</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6>üìã –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤:</h6>
                                                    <div class="row g-2">
                                                        <div class="col-6">
                                                            <div class="d-flex justify-content-between">
                                                                <span>–í –æ–∂–∏–¥–∞–Ω–∏–∏:</span>
                                                                <span class="badge bg-secondary">{{ stats.get('pending_orders', 0) }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="d-flex justify-content-between">
                                                                <span>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ:</span>
                                                                <span class="badge bg-info">{{ stats.get('processing_orders', 0) }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="d-flex justify-content-between">
                                                                <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ:</span>
                                                                <span class="badge bg-success">{{ stats.get('completed_orders', 0) }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div class="d-flex justify-content-between">
                                                                <span>–û—Ç–º–µ–Ω–µ–Ω–æ:</span>
                                                                <span class="badge bg-danger">{{ stats.get('cancelled_orders', 0) }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-12">
                                                            <div class="d-flex justify-content-between">
                                                                <span>–¢—Ä–µ–±—É–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞:</span>
                                                                <span class="badge bg-warning">{{ stats.get('refund_required_orders', 0) }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6>üí∞ –§–∏–Ω–∞–Ω—Å—ã:</h6>
                                                    <div class="alert alert-success">
                                                        <strong>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞:</strong> {{ "%.2f"|format(stats.get('total_revenue', 0)) }} ‚ÇΩ
                                                    </div>
                                                    
                                                    {% if stats.get('refund_reasons') %}
                                                    <h6>üîÑ –ü—Ä–∏—á–∏–Ω—ã –≤–æ–∑–≤—Ä–∞—Ç–æ–≤:</h6>
                                                    {% for reason, count in stats.get('refund_reasons', {}).items() %}
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <small>{{ reason }}</small>
                                                        <span class="badge bg-warning">{{ count }}</span>
                                                    </div>
                                                    {% endfor %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-calendar fa-2x mb-2"></i><br>
                                    –¢—É—Ä–Ω–∏—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if events.pages > 1 %}
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if events.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('mom.events', page=events.prev_num) }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
                        </li>
                    {% endif %}
                    
                    {% for page_num in events.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != events.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('mom.events', page=page_num) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if events.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('mom.events', page=events.next_num) }}">–°–ª–µ–¥—É—é—â–∞—è</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

