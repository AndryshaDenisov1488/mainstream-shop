{% extends "base.html" %}

{% block title %}Заказ {{ order.generated_order_number }} - Панель оператора{% endblock %}

{% block content %}
{% set operator_locked_statuses = [
    'cancelled_unpaid', 'cancelled_manual', 'refunded_full',
    'refunded_partial', 'completed', 'completed_partial_refund'
] %}
{% set operator_manageable_statuses = [
    'processing', 'awaiting_info', 'ready', 'links_sent',
    'completed', 'completed_partial_refund', 'refund_required', 'cancelled_manual'
] %}
<div class="container-fluid layout-wide py-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">Заказ {{ order.generated_order_number }}</h1>
                <div>
                    <a href="{{ url_for('operator.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Назад к панели
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Order Information -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Информация о заказе</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Номер заказа:</strong> {{ order.generated_order_number }}</p>
                            <p><strong>Статус:</strong> 
                                <span class="badge bg-{{ order_status_badge(order.status) }}">
                                    {{ order_status_label(order.status) }}
                                </span>
                            </p>
                            <p><strong>Дата заказа:</strong> {{ order.created_at.strftime('%d.%m.%Y %H:%M') if order.created_at else 'Не указано' }}</p>
                            <p><strong>Сумма:</strong> {{ "%.2f"|format(order.total_amount) }} ₽</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Турнир:</strong> {{ order.event.name if order.event else 'Неизвестный турнир' }}</p>
                            <p><strong>Категория:</strong> {{ order.category.name if order.category else 'Неизвестная категория' }}</p>
                            <p><strong>Спортсмен:</strong> {{ order.athlete.name if order.athlete else 'Неизвестный спортсмен' }}</p>
                        </div>
                    </div>
                    
                    <!-- Customer Information -->
                    <hr>
                    <h6>Контактная информация:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Клиент:</strong> 
                                {% if order.contact_first_name and order.contact_last_name %}
                                    {{ order.contact_last_name }} {{ order.contact_first_name }}
                                {% elif order.customer %}
                                    {{ order.customer.full_name }}
                                {% else %}
                                    {{ order.contact_email }}
                                {% endif %}
                            </p>
                            <p><strong>Email:</strong> {{ order.contact_email }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Телефон:</strong> {{ order.contact_phone or 'Не указан' }}</p>
                            {% if order.comment %}
                                <p><strong>Комментарий клиента:</strong> {{ order.comment }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video Types -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Заказанные видео</h5>
                </div>
                <div class="card-body">
                    {% if order.video_types %}
                        <div class="row">
                            {% for video_type_id in order.video_types %}
                                {% if video_type_id %}
                                    {% set video_type = video_types_dict.get(video_type_id|string) if video_types_dict else None %}
                                    <div class="col-md-6 mb-3">
                                        <div class="border rounded p-3">
                                            <h6>{{ video_type.name if video_type else 'Неизвестный тип' }}</h6>
                                            {% if video_type %}
                                                <p class="text-muted mb-2">{{ video_type.description }}</p>
                                                <p class="mb-0"><strong>Цена: {{ "%.0f"|format(video_type.price) }} ₽</strong></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">Типы видео не указаны</p>
                    {% endif %}
                </div>
            </div>

            <!-- Video Links Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-link me-2"></i>Ссылки на видео</h5>
                </div>
                <div class="card-body">
                    <form id="sendLinksFormPage">
                        <input type="hidden" name="order_id" id="pageOrderId" value="{{ order.id }}">
                        <input type="hidden" name="client_email" value="{{ order.contact_email }}">
                        <input type="hidden" name="client_name" value="{{ order.contact_last_name or '' }} {{ order.contact_first_name or '' }}">

                        {% if order.video_types %}
                            {% set video_type_counts = {} %}
                            {% for video_type_id in order.video_types %}
                                {% set video_type_id_str = video_type_id|string %}
                                {% if video_type_id_str in video_type_counts %}
                                    {% set _ = video_type_counts.update({video_type_id_str: video_type_counts[video_type_id_str] + 1}) %}
                                {% else %}
                                    {% set _ = video_type_counts.update({video_type_id_str: 1}) %}
                                {% endif %}
                            {% endfor %}
                            {% set video_type_indexes = {} %}
                            {% for video_type_id in order.video_types %}
                                {% set video_type_id_str = video_type_id|string %}
                                {% set video_type = video_types_dict.get(video_type_id_str) if video_types_dict else None %}
                                {% if video_type_id_str not in video_type_indexes %}
                                    {% set _ = video_type_indexes.update({video_type_id_str: 0}) %}
                                {% else %}
                                    {% set _ = video_type_indexes.update({video_type_id_str: video_type_indexes[video_type_id_str] + 1}) %}
                                {% endif %}
                                {% set current_index = video_type_indexes[video_type_id_str] %}
                                {% set field_key = video_type_id_str + '_' + current_index|string %}
                                {% set is_multiple = video_type_counts.get(video_type_id_str, 1) > 1 %}
                                <div class="mb-3">
                                    <label for="video_link_{{ field_key }}" class="form-label">
                                        {% if is_multiple %}
                                            {{ video_type.name if video_type else 'Неизвестный тип' }} #{{ current_index + 1 }} ({{ "%.0f"|format(video_type.price) }} ₽)
                                        {% else %}
                                            {{ video_type.name if video_type else 'Неизвестный тип' }} ({{ "%.0f"|format(video_type.price) }} ₽)
                                        {% endif %}
                                    </label>
                                    <input type="url" class="form-control" id="video_link_{{ field_key }}"
                                           name="video_link_{{ field_key }}"
                                           value="{{ order.video_links.get(field_key, '') if order.video_links else '' }}"
                                           placeholder="Вставьте ссылку на скачивание видео"
                                           {% if order.status in operator_locked_statuses %}disabled{% endif %}>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">Типы видео не указаны</p>
                        {% endif %}


                        <button type="button" class="btn btn-primary" onclick="sendVideoLinks()"
                                {% if order.status in operator_locked_statuses %}disabled{% endif %}>
                            <i class="fas fa-paper-plane me-2"></i>Отправить ссылки
                        </button>
                        {% if order.status not in operator_locked_statuses %}
                            <p class="mt-2 text-muted">
                                <small>Для полного возврата и отмены заказа измените статус заказа в блоке "Действия".</small>
                            </p>
                        {% endif %}
                    </form>
                </div>
            </div>

            <!-- Video Links (if sent) -->
            {% if order.video_links %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Отправленные ссылки</h5>
                </div>
                <div class="card-body">
                    {% for video_type_id, link in order.video_links.items() %}
                        {% if video_type_id %}
                            {% set video_type = video_types_dict.get(video_type_id|string) if video_types_dict else None %}
                            <div class="mb-3 p-3 border rounded">
                                <h6>{{ video_type.name if video_type else 'Неизвестный тип' }}</h6>
                                <a href="{{ link }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-external-link-alt me-1"></i>{{ link }}
                                </a>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Operator Comments Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Комментарии оператора</h5>
                </div>
                <div class="card-body">
                    <!-- Operator Comment -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Комментарий (опционально):</strong></label>
                        <textarea class="form-control" id="operatorCommentInput" rows="3" placeholder="Добавьте комментарий...">{{ order.operator_comment or '' }}</textarea>
                    </div>
                    
                    <!-- Refund Reason -->
                    <div class="mb-3" id="refundReasonDisplaySection" {% if not order.refund_reason %}style="display: none;"{% endif %}>
                        <label class="form-label"><strong>Причина возврата:</strong></label>
                        <div id="refundReasonDisplay" class="alert alert-warning">
                            {% if order.refund_reason %}
                                {{ order.refund_reason }}
                            {% else %}
                                <span class="text-muted">Причина возврата не указана</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Refund Status -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Статус возврата:</strong></label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="refundStatusCheckbox"
                                   {% if order.status == 'refund_required' %}checked{% endif %}>
                            <label class="form-check-label" for="refundStatusCheckbox">
                                Требуется частичный возврат
                            </label>
                        </div>
                    </div>
                    
                    <!-- Refund Reason Input -->
                    <div class="mb-3" id="refundReasonInputSection" style="display: none;">
                        <label class="form-label"><strong>Причина возврата:</strong></label>
                        <textarea class="form-control" id="refundReasonInput" rows="3" placeholder="Укажите причину возврата и сумму...">{{ order.refund_reason or '' }}</textarea>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" id="saveCommentsBtn">
                            <i class="fas fa-save me-1"></i>Сохранить изменения
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Sidebar -->
        <div class="col-lg-4">
            <!-- Order Tabs -->
            <div class="card mb-4">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="orderTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="management-tab" data-bs-toggle="tab" data-bs-target="#management" type="button" role="tab">
                                <i class="fas fa-cog me-1"></i>Управление
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">
                                <i class="fas fa-comments me-1"></i>Чат
                                <span class="badge bg-danger ms-1" id="chatUnreadCount" style="display: none;">0</span>
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="orderTabsContent">
                        <!-- Management Tab -->
                        <div class="tab-pane fade show active" id="management" role="tabpanel">
                            <h5 class="mb-3">Управление заказом</h5>
                    <!-- Status change is available for all orders -->
                        <div class="mb-3">
                            <label class="form-label">Текущий статус</label>
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-{{ order_status_badge(order.status) }} me-2">
                                    {{ order_status_label(order.status) }}
                                </span>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-warning btn-sm" id="changeStatusBtn" 
                                        data-order-id="{{ order.id }}" 
                                        data-order-status="{{ order.status }}" 
                                        data-order-number="{{ order.generated_order_number }}">
                                    <i class="fas fa-edit me-1"></i>Изменить статус
                                </button>
                                {% if order.status not in operator_locked_statuses %}
                                <button type="button" class="btn btn-danger btn-sm" id="cancelOrderBtn" 
                                        data-order-id="{{ order.id }}" 
                                        data-order-number="{{ order.generated_order_number }}">
                                    <i class="fas fa-times me-1"></i>Отменить заказ
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="operatorComment" class="form-label">Комментарий</label>
                            <textarea class="form-control" id="operatorComment" rows="3" placeholder="Добавьте комментарий..."></textarea>
                        </div>
                        
                    
                    {% if order.status == 'processing' %}
                        <hr>
                        <button class="btn btn-primary w-100 mb-2" id="openModalButton1" 
                                data-order-id="{{ order.id }}" 
                                data-order-number="{{ order.generated_order_number }}" 
                                data-client-email="{{ order.contact_email }}" 
                                data-client-first-name="{{ order.contact_first_name or '' }}" 
                                data-client-last-name="{{ order.contact_last_name or '' }}">
                            <i class="fas fa-link me-1"></i>Отправить ссылки на видео
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Order Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Быстрые действия</h5>
                </div>
                <div class="card-body">
                    {% if order.status == 'paid' and not order.operator_id %}
                        <a href="{{ url_for('operator.take_order', order_id=order.id) }}" class="btn btn-success w-100 mb-2">
                            <i class="fas fa-hand-paper me-1"></i>Взять в работу
                        </a>
                    {% endif %}
                    
                    {% if order.status == 'processing' %}
                        <button class="btn btn-primary w-100 mb-2" id="openModalButton2" 
                                data-order-id="{{ order.id }}" 
                                data-order-number="{{ order.generated_order_number }}" 
                                data-client-email="{{ order.contact_email }}" 
                                data-client-first-name="{{ order.contact_first_name or '' }}" 
                                data-client-last-name="{{ order.contact_last_name or '' }}">
                            <i class="fas fa-link me-1"></i>Отправить ссылки
                        </button>
                    {% endif %}
                    
                    <button class="btn btn-outline-secondary w-100" onclick="window.print()">
                        <i class="fas fa-print me-1"></i>Печать заказа
                    </button>
                </div>
            </div>
                        </div>
                        
                        <!-- Chat Tab -->
                        <div class="tab-pane fade" id="chat" role="tabpanel">
                            <h5 class="mb-3">Чат по заказу</h5>
                            
                            <!-- Chat Messages -->
                            <div id="chatMessages" class="border rounded p-3 mb-3" style="height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Загрузка сообщений...
                                </div>
                            </div>
                            
                            <!-- Chat Input -->
                            <div class="mb-3">
                                <div class="input-group">
                                    <textarea class="form-control" id="chatMessageInput" rows="2" placeholder="Введите сообщение..." maxlength="5000"></textarea>
                                    <button class="btn btn-outline-secondary" type="button" id="attachFileBtn" title="Прикрепить файл">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                </div>
                                <input type="file" id="chatFileInput" style="display: none;" accept=".png,.jpg,.jpeg,.gif,.pdf,.doc,.docx,.txt">
                                <small class="text-muted">Максимум 5000 символов. Поддерживаемые файлы: изображения, PDF, документы</small>
                            </div>
                            
                            <!-- Send Button -->
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-primary" id="sendChatMessageBtn">
                                    <i class="fas fa-paper-plane me-1"></i>Отправить
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" id="loadMoreMessagesBtn" style="display: none;">
                                    <i class="fas fa-history me-1"></i>Загрузить еще
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Send Links Modal -->
<div class="modal fade" id="sendLinksModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Отправить ссылки на видео</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="sendLinksForm">
                <input type="hidden" name="order_id" id="modalOrderId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Заказ:</label>
                                <input type="text" class="form-control" id="modalOrderNumber" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email клиента:</label>
                                <input type="email" class="form-control" name="client_email" id="modalClientEmail">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Клиент:</label>
                        <input type="text" class="form-control" name="client_name" id="modalClientName" placeholder="Фамилия Имя">
                    </div>
                    
                    <div id="videoLinksContainer">
                        <!-- Video links will be generated here -->
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="partialRefundCheckbox">
                            <label class="form-check-label" for="partialRefundCheckbox">
                                Требуется частичный возврат
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="refundComment" class="form-label">Комментарий к возврату (если нужен):</label>
                        <textarea class="form-control" id="refundComment" rows="2" placeholder="Укажите причину возврата и сумму..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="message" class="form-label">Сообщение клиенту (опционально):</label>
                        <textarea class="form-control" name="message" id="message" rows="2" placeholder="Дополнительное сообщение клиенту..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="sendVideoLinks()">Отправить ссылки</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Define sendVideoLinks function first to avoid ReferenceError
function sendVideoLinks() {
    // Определяем, какая форма используется - модальная или на странице
    const modal = document.getElementById('sendLinksModal');
    const isModalOpen = modal && modal.classList.contains('show');
    
    let form, orderId;
    
    if (isModalOpen) {
        // Используем модальную форму
        form = modal.querySelector('#sendLinksForm');
        orderId = document.getElementById('modalOrderId')?.value;
    } else {
        // Используем форму на странице
        form = document.getElementById('sendLinksFormPage');
        orderId = document.getElementById('pageOrderId')?.value || '{{ order.id }}';
    }
    
    if (!form) {
        alert('Ошибка: форма не найдена');
        console.error('Form not found');
        return;
    }
    
    if (!orderId) {
        alert('Ошибка: не найден ID заказа');
        console.error('Order ID not found');
        return;
    }
    
    const formData = new FormData(form);
    
    // Ищем поля ссылок в активной форме
    const videoLinks = {};
    
    if (isModalOpen) {
        // Ищем в модальном окне
        const videoLinksContainer = document.getElementById('videoLinksContainer');
        if (videoLinksContainer) {
            const videoLinkInputs = videoLinksContainer.querySelectorAll('input[name^="video_links["]');
            videoLinkInputs.forEach(input => {
                const match = input.name.match(/video_links\[(.+)\]/);
                const value = input.value.trim();
                if (match && value) {
                    videoLinks[match[1]] = value;
                }
            });
        }
    } else {
        // Ищем в форме на странице
        const videoLinkInputs = form.querySelectorAll('input[name^="video_link_"]');
        videoLinkInputs.forEach(input => {
            const fieldName = input.name.replace('video_link_', '');
            const value = input.value.trim();
            if (fieldName && value) {
                // Поддерживаем как старый формат (video_type_id), так и новый (video_type_id_index)
                videoLinks[fieldName] = value;
            }
        });
    }
    
    console.log('Found video links:', videoLinks);
    
    // Check if at least one link is provided
    if (Object.keys(videoLinks).length === 0) {
        alert('Пожалуйста, введите хотя бы одну ссылку на видео');
        return;
    }
    
    // Get refund data from the modal
    const partialRefundCheckbox = document.getElementById('partialRefundCheckbox') || modal?.querySelector('#partialRefundCheckbox');
    const partialRefund = partialRefundCheckbox ? partialRefundCheckbox.checked : false;
    
    // Get operator comment from the input field
    const messageInput = document.getElementById('message') || form.querySelector('#message');
    const message = messageInput ? messageInput.value.trim() : '';
    
    // Get refund reason from the input field
    const refundCommentInput = document.getElementById('refundComment') || modal?.querySelector('#refundComment');
    const refundComment = refundCommentInput ? refundCommentInput.value.trim() : '';
    
    // If it's a refund case but no refund reason provided
    if (partialRefund && !refundComment.trim()) {
        alert('При частичном возврате необходимо указать причину возврата в разделе "Комментарии оператора"');
        return;
    }
    
    const requestData = {
        client_name: formData.get('client_name'),
        client_email: formData.get('client_email'),
        video_links: videoLinks,
        message: message,
        partial_refund: partialRefund,
        refund_comment: refundComment
    };
    
    console.log('Sending video links:', requestData);
    
    fetch('/api/order/' + orderId + '/send-links', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            alert('Ссылки отправлены успешно!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('sendLinksModal'));
            if (modal) {
                modal.hide();
            }
            // Update display without reloading the page
            updateCommentsDisplay(message, refundComment, partialRefund);
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при отправке ссылок: ' + error.message);
    });
}

// Old functions removed - status change now handled by modal


function openSendLinksModal(orderId, orderNumber, clientEmail, clientFirstName, clientLastName) {
    document.getElementById('modalOrderId').value = orderId;
    document.getElementById('modalOrderNumber').value = orderNumber;
    document.getElementById('modalClientEmail').value = clientEmail;
    
    const clientName = `${clientLastName} ${clientFirstName}`.trim();
    document.getElementById('modalClientName').value = clientName;
    
    // Load order data from API for synchronization
    fetch(`/api/order/${orderId}/info`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const order = data.order;
                console.log('Order data loaded for modal:', order);
                
                // Update comments display on main page
                updateCommentsDisplay(order.operator_comment, order.refund_reason, order.status === 'refund_required');
                
                // Generate video link fields based on API data
                const container = document.getElementById('videoLinksContainer');
                container.innerHTML = '';
                
                if (order.video_types && Array.isArray(order.video_types) && order.video_types.length > 0) {
                    order.video_types.forEach((videoType, index) => {
                        if (videoType && videoType.id && videoType.name) {
                            const div = document.createElement('div');
                            div.className = 'mb-3';
                            const existingLink = order.video_links ? order.video_links[videoType.id] : '';
                            
                            div.innerHTML = `
                                <label for="video_link_${videoType.id}" class="form-label">${videoType.name}</label>
                                <input type="url" class="form-control" name="video_links[${videoType.id}]" id="video_link_${videoType.id}" 
                                       value="${existingLink || ''}" placeholder="Вставьте ссылку на скачивание видео">
                            `;
                            container.appendChild(div);
                        }
                    });
                }
            } else {
                console.error('Failed to load order data:', data.error);
                // Fallback to static generation
                generateStaticVideoLinks();
            }
        })
        .catch(error => {
            console.error('Error loading order data:', error);
            // Fallback to static generation
            generateStaticVideoLinks();
        });
    
    // Show modal
    var modal = new bootstrap.Modal(document.getElementById('sendLinksModal'));
    modal.show();
}

function generateStaticVideoLinks() {
    // Fallback function for static generation
    const container = document.getElementById('videoLinksContainer');
    container.innerHTML = '';
    
    // This function will be called only as fallback if API fails
    // The video links are already generated in the HTML template
    console.log('Using static video links generation as fallback');
}

// Function to update comments display
function updateCommentsDisplay(operatorComment, refundReason, isRefundRequired) {
    // Update operator comment display
    const operatorCommentDisplay = document.getElementById('operatorCommentDisplay');
    if (operatorCommentDisplay) {
        if (operatorComment && operatorComment.trim()) {
            operatorCommentDisplay.innerHTML = operatorComment;
        } else {
            operatorCommentDisplay.innerHTML = '<span class="text-muted">Комментарий не указан</span>';
        }
    }
    
    // Update refund reason display
    const refundReasonDisplay = document.getElementById('refundReasonDisplay');
    const refundReasonDisplaySection = document.getElementById('refundReasonDisplaySection');
    if (refundReasonDisplay && refundReasonDisplaySection) {
        if (refundReason && refundReason.trim()) {
            refundReasonDisplay.innerHTML = refundReason;
            refundReasonDisplaySection.style.display = 'block';
        } else {
            refundReasonDisplay.innerHTML = '<span class="text-muted">Причина возврата не указана</span>';
            refundReasonDisplaySection.style.display = 'none';
        }
    }
    
    // Update refund status checkbox
    const refundStatusCheckbox = document.getElementById('refundStatusCheckbox');
    if (refundStatusCheckbox) {
        refundStatusCheckbox.checked = isRefundRequired;
    }
}

// Add event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Handle change status button
    const changeStatusBtn = document.getElementById('changeStatusBtn');
    if (changeStatusBtn) {
        changeStatusBtn.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            const orderStatus = this.getAttribute('data-order-status');
            const orderNumber = this.getAttribute('data-order-number');
            openStatusModal(orderId, orderStatus, orderNumber);
        });
    }
    
    // Handle cancel order button
    const cancelOrderBtn = document.getElementById('cancelOrderBtn');
    if (cancelOrderBtn) {
        cancelOrderBtn.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            const orderNumber = this.getAttribute('data-order-number');
            openCancelOrderModal(orderId, orderNumber);
        });
    }
    
    // Handle open modal buttons
    const openModalButton1 = document.getElementById('openModalButton1');
    const openModalButton2 = document.getElementById('openModalButton2');
    
    [openModalButton1, openModalButton2].forEach(button => {
        if (button) {
            button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                const orderNumber = this.getAttribute('data-order-number');
                const clientEmail = this.getAttribute('data-client-email');
                const clientFirstName = this.getAttribute('data-client-first-name');
                const clientLastName = this.getAttribute('data-client-last-name');
                openSendLinksModal(orderId, orderNumber, clientEmail, clientFirstName, clientLastName);
            });
        }
    });
    
    // Handle refund status checkbox
    const refundStatusCheckbox = document.getElementById('refundStatusCheckbox');
    const refundReasonInputSection = document.getElementById('refundReasonInputSection');
    
    if (refundStatusCheckbox && refundReasonInputSection) {
        refundStatusCheckbox.addEventListener('change', function() {
            if (this.checked) {
                refundReasonInputSection.style.display = 'block';
            } else {
                refundReasonInputSection.style.display = 'none';
            }
        });
        
        // Set initial state
        if (refundStatusCheckbox.checked) {
            refundReasonInputSection.style.display = 'block';
        }
    }
    
    // Handle save comments button
    const saveCommentsBtn = document.getElementById('saveCommentsBtn');
    if (saveCommentsBtn) {
        saveCommentsBtn.addEventListener('click', function() {
            saveComments();
        });
    }
});

// Function to save comments
function saveComments() {
    const orderId = parseInt('{{ order.id if order.id else 0 }}');
    const operatorComment = document.getElementById('operatorCommentInput').value.trim();
    const refundStatusCheckbox = document.getElementById('refundStatusCheckbox');
    const refundReason = document.getElementById('refundReasonInput').value.trim();
    
    const partialRefund = refundStatusCheckbox ? refundStatusCheckbox.checked : false;
    
    // If partial refund is checked but no reason provided
    if (partialRefund && !refundReason.trim()) {
        alert('При частичном возврате необходимо указать причину возврата');
        return;
    }
    
    const requestData = {
        operator_comment: operatorComment,
        partial_refund: partialRefund,
        refund_reason: refundReason
    };
    
    fetch(`/api/order/${orderId}/update-comments`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Комментарии сохранены успешно!');
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при сохранении комментариев');
    });
}
</script>

<!-- Status Change Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">Изменить статус заказа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <input type="hidden" id="statusOrderId" name="order_id">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">Новый статус</label>
                        <select class="form-select" id="newStatus" name="status" required>
                            {% for meta in order_status_choices(include_cancelled_group=False) if meta.code in operator_manageable_statuses %}
                                <option value="{{ meta.code }}">{{ meta.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="statusComment" class="form-label">Комментарий (необязательно)</label>
                        <textarea class="form-control" id="statusComment" name="comment" rows="3" placeholder="Добавить комментарий к изменению статуса..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="button" class="btn btn-primary" id="confirmChangeStatusBtn">Изменить статус</button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelOrderModalLabel">Отменить заказ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Вы уверены, что хотите отменить заказ <strong id="cancelOrderNumber"></strong>?
                </div>
                <form id="cancelOrderForm">
                    <input type="hidden" id="cancelOrderId" name="order_id">
                    <div class="mb-3">
                        <label for="cancelReason" class="form-label">Причина отмены <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="cancelReason" name="reason" rows="3" placeholder="Укажите причину отмены заказа..." required></textarea>
                        <small class="form-text text-muted">Причина отмены обязательна и будет отправлена клиенту по email</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmCancelOrderBtn">
                    <i class="fas fa-times me-1"></i>Отменить заказ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Function to open status modal
function openStatusModal(orderId, currentStatus, orderNumber) {
    document.getElementById('statusOrderId').value = orderId;
    document.getElementById('newStatus').value = currentStatus;
    document.getElementById('statusComment').value = '';
    
    var modal = new bootstrap.Modal(document.getElementById('statusModal'));
    modal.show();
}

// Function to open cancel order modal
function openCancelOrderModal(orderId, orderNumber) {
    document.getElementById('cancelOrderId').value = orderId;
    document.getElementById('cancelOrderNumber').textContent = orderNumber;
    document.getElementById('cancelReason').value = '';
    
    var modal = new bootstrap.Modal(document.getElementById('cancelOrderModal'));
    modal.show();
}

// Handle status change button in modal
document.getElementById('confirmChangeStatusBtn').addEventListener('click', function() {
    const form = document.getElementById('statusForm');
    const formData = new FormData(form);
    const orderId = formData.get('order_id');
    const status = formData.get('status');
    const comment = formData.get('comment');
    
    if (status === 'cancelled_manual' && !comment.trim()) {
        alert('При отмене заказа необходимо указать причину в комментарии');
        return;
    }
    
    fetch(`/api/order/${orderId}/operator-change-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: status,
            comment: comment
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при изменении статуса');
    });
});

// Handle cancel order button in modal
document.getElementById('confirmCancelOrderBtn').addEventListener('click', function() {
    const form = document.getElementById('cancelOrderForm');
    const formData = new FormData(form);
    const orderId = formData.get('order_id');
    const reason = formData.get('reason');
    
    if (!reason.trim()) {
        alert('Необходимо указать причину отмены заказа');
        return;
    }
    
    if (!confirm('Вы уверены, что хотите отменить этот заказ? Это действие нельзя отменить.')) {
        return;
    }
    
    fetch(`/api/order/${orderId}/operator-change-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: 'cancelled_manual',
            comment: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Заказ успешно отменен');
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при отмене заказа');
    });
});

// Chat functionality
let currentChatPage = 1;
let isLoadingMessages = false;

// Load chat messages
function loadChatMessages(page = 1) {
    if (isLoadingMessages) return;
    isLoadingMessages = true;
    
    fetch(`/api/chat/order/{{ order.id }}/messages?page=${page}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMessages(data.messages, page === 1);
                currentChatPage = page;
                
                // Show/hide load more button
                const loadMoreBtn = document.getElementById('loadMoreMessagesBtn');
                if (data.has_prev) {
                    loadMoreBtn.style.display = 'block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            } else {
                console.error('Failed to load messages:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading messages:', error);
        })
        .finally(() => {
            isLoadingMessages = false;
        });
}

// Display messages in chat
function displayMessages(messages, clear = false) {
    const chatContainer = document.getElementById('chatMessages');
    
    if (clear) {
        chatContainer.innerHTML = '';
    }
    
    if (messages.length === 0 && clear) {
        chatContainer.innerHTML = '<div class="text-center text-muted">Пока нет сообщений</div>';
        return;
    }
    
    messages.forEach(message => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-3 p-2 rounded ${message.message_type === 'system' ? 'bg-light border-start border-info border-3' : 'bg-white border'}`;
        
        const isCurrentUser = message.sender_id === parseInt('{{ current_user.id }}');
        const alignment = isCurrentUser ? 'text-end' : 'text-start';
        
        messageDiv.innerHTML = `
            <div class="${alignment}">
                <div class="d-flex ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'}">
                    <div class="${isCurrentUser ? 'order-2' : 'order-1'}">
                        <small class="text-muted">${message.sender_name} (${message.sender_role})</small>
                        <div class="message-content ${isCurrentUser ? 'bg-primary text-white' : 'bg-light'} p-2 rounded mt-1">
                            ${message.message.replace(/\n/g, '<br>')}
                        </div>
                        ${message.attachment_name ? `<div class="mt-2"><a href="/uploads/chat/${message.attachment_path}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-download me-1"></i>Скачать файл: ${message.attachment_name}</a></div>` : ''}
                        <small class="text-muted d-block mt-1">${new Date(message.created_at).toLocaleString('ru-RU')}</small>
                    </div>
                </div>
            </div>
        `;
        
        if (clear) {
            chatContainer.appendChild(messageDiv);
        } else {
            chatContainer.insertBefore(messageDiv, chatContainer.firstChild);
        }
    });
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Send chat message
function sendChatMessage() {
    const messageInput = document.getElementById('chatMessageInput');
    const fileInput = document.getElementById('chatFileInput');
    const message = messageInput.value.trim();
    
    if (!message && !fileInput.files[0]) {
        alert('Введите сообщение или прикрепите файл');
        return;
    }
    
    const formData = new FormData();
    formData.append('message', message);
    if (fileInput.files[0]) {
        formData.append('attachment', fileInput.files[0]);
    }
    
    fetch(`/api/chat/order/{{ order.id }}/send`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || `HTTP ${response.status}: ${response.statusText}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            fileInput.value = '';
            loadChatMessages(1); // Reload messages
            updateUnreadCount();
        } else {
            alert('Ошибка отправки сообщения: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        alert('Произошла ошибка при отправке сообщения: ' + error.message);
    });
}

// Update unread message count
function updateUnreadCount() {
    fetch(`/api/chat/order/{{ order.id }}/unread-count`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const badge = document.getElementById('chatUnreadCount');
                if (data.unread_count > 0) {
                    badge.textContent = data.unread_count;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            }
        })
        .catch(error => {
            console.error('Error updating unread count:', error);
        });
}

// Mark messages as read when chat tab is shown
document.getElementById('chat-tab').addEventListener('shown.bs.tab', function() {
    fetch(`/api/chat/order/{{ order.id }}/mark-read`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateUnreadCount();
        }
    });
});

// Load messages when chat tab is shown
document.getElementById('chat-tab').addEventListener('shown.bs.tab', function() {
    loadChatMessages(1);
});

// Event listeners for chat
document.getElementById('sendChatMessageBtn').addEventListener('click', sendChatMessage);

document.getElementById('chatMessageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
    }
});

document.getElementById('attachFileBtn').addEventListener('click', function() {
    document.getElementById('chatFileInput').click();
});

document.getElementById('chatFileInput').addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
            alert('Файл слишком большой. Максимальный размер: 10MB');
            this.value = '';
            return;
        }
        
        // Show file name
        const messageInput = document.getElementById('chatMessageInput');
        messageInput.placeholder = `Файл: ${file.name}. Введите сообщение (необязательно)...`;
    }
});

document.getElementById('loadMoreMessagesBtn').addEventListener('click', function() {
    loadChatMessages(currentChatPage + 1);
});

// Auto-refresh unread count every 2 minutes
setInterval(updateUnreadCount, 120000);

// ✅ Auto-refresh chat messages every 10 seconds when chat tab is active
let chatRefreshInterval = null;

document.getElementById('chat-tab').addEventListener('shown.bs.tab', function() {
    // Start auto-refresh when chat is opened
    if (!chatRefreshInterval) {
        chatRefreshInterval = setInterval(function() {
            loadChatMessages(1);
        }, 10000); // Обновление каждые 10 секунд
    }
});

document.getElementById('chat-tab').addEventListener('hidden.bs.tab', function() {
    // Stop auto-refresh when chat is closed
    if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
    }
});

// Initial load of unread count
updateUnreadCount();
</script>
{% endblock %}