# üîç –ü–û–õ–ù–´–ô –ê–£–î–ò–¢ –°–ò–°–¢–ï–ú–´ MAINSTREAM SHOP
## –î–∞—Ç–∞: 7 –Ω–æ—è–±—Ä—è 2024
## –û–±—ä–µ–º: ~31,000 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

---

## üìä EXECUTIVE SUMMARY

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: 7.5/10 ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ –•–æ—Ä–æ—à–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ —Ä–æ–ª—è–º
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Flask-SQLAlchemy ORM (–∑–∞—â–∏—Ç–∞ –æ—Ç SQL injection)
- ‚úÖ CSRF –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ Flask-WTF
- ‚úÖ –ê—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç XXE –∞—Ç–∞–∫ (defusedxml)
- ‚úÖ –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π (werkzeug)
- ‚úÖ Rate limiting –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ä–æ—É—Ç–∞—Ö

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- üî¥ **3 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö** —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- üü° **12 –≤–∞–∂–Ω—ã—Ö** –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –ª–æ–≥–∏–∫–∏
- üü¢ **25 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π** –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

---

## üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (–¢–†–ï–ë–£–Æ–¢ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ì–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø)

### 1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ —á–∞—Ç–µ**
**–§–∞–π–ª:** `app/api/chat_endpoints.py`  
**–ü—Ä–æ–±–ª–µ–º–∞:**  
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ MIME-—Ç–∏–ø–∞ —Ñ–∞–π–ª–∞ (—Ç–æ–ª—å–∫–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)
- –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º
- –ù–µ—Ç –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

**–ö —á–µ–º—É –ø—Ä–∏–≤–æ–¥–∏—Ç:**
- –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –ö–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
```python
import magic  # python-magic

def validate_file_content(file):
    """Validate file by MIME type, not just extension"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π MIME-type —Ñ–∞–π–ª–∞
    mime = magic.from_buffer(file.read(2048), mime=True)
    file.seek(0)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –≤ –Ω–∞—á–∞–ª–æ
    
    allowed_mimes = [
        'image/jpeg', 'image/png', 'image/gif',
        'application/pdf', 'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'video/mp4', 'video/quicktime'
    ]
    
    if mime not in allowed_mimes:
        raise ValueError(f'–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞: {mime}')
    
    return mime

# –í chat_endpoints.py:
@bp.route('/chat/order/<int:order_id>/send', methods=['POST'])
def send_message(order_id):
    if 'attachment' in request.files:
        file = request.files['attachment']
        # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π MIME-type
        mime_type = validate_file_content(file)
        # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ù–´–ô  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞

---

### 2. **Path Traversal —É—è–∑–≤–∏–º–æ—Å—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤**
**–§–∞–π–ª:** `app/api/chat_endpoints.py` (—Å—Ç—Ä–æ–∫–∞ ~45)  
**–ü—Ä–æ–±–ª–µ–º–∞:**  
```python
# –£–Ø–ó–í–ò–ú–´–ô –ö–û–î:
filename = secure_filename(file.filename)
filepath = os.path.join(upload_folder, filename)
```
- `secure_filename` –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –≤—Å–µ—Ö –∞—Ç–∞–∫
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `../` –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞

**–ö —á–µ–º—É –ø—Ä–∏–≤–æ–¥–∏—Ç:**
- –ó–∞–ø–∏—Å—å —Ñ–∞–π–ª–æ–≤ –≤ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
- –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –†–∞—Å–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

**–†–µ—à–µ–Ω–∏–µ:**
```python
import uuid
from pathlib import Path

def save_uploaded_file(file, upload_folder):
    """Safely save uploaded file with random name"""
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
    file_ext = Path(file.filename).suffix.lower()
    unique_filename = f"{uuid.uuid4().hex}{file_ext}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—É—Ç—å –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã upload_folder
    filepath = Path(upload_folder) / unique_filename
    if not filepath.resolve().is_relative_to(Path(upload_folder).resolve()):
        raise ValueError("Invalid file path")
    
    file.save(str(filepath))
    return unique_filename

# –í chat_endpoints.py:
attachment_filename = save_uploaded_file(file, upload_folder)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ù–´–ô  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–í—Ä–µ–º—è:** 1 —á–∞—Å

---

### 3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∑–∞–∫–∞–∑–∞ –≤ API**
**–§–∞–π–ª:** `app/api/routes.py`, `app/api/chat_endpoints.py`  
**–ü—Ä–æ–±–ª–µ–º–∞:**  
```python
# –£–Ø–ó–í–ò–ú–´–ô –ö–û–î:
@bp.route('/api/order/<int:order_id>/status')
def get_order_status(order_id):
    order = Order.query.get_or_404(order_id)
    # ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –≤–ª–∞–¥–µ–ª–µ—Ü –∑–∞–∫–∞–∑–∞
    return jsonify({'status': order.status})
```

**–ö —á–µ–º—É –ø—Ä–∏–≤–æ–¥–∏—Ç:**
- –õ—é–±–æ–π –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —á—É–∂–∏–µ –∑–∞–∫–∞–∑—ã
- IDOR (Insecure Direct Object Reference) —É—è–∑–≤–∏–º–æ—Å—Ç—å
- –£—Ç–µ—á–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–∞—Ä—É—à–µ–Ω–∏–µ 152-–§–ó)

**–†–µ—à–µ–Ω–∏–µ:**
```python
@bp.route('/api/order/<int:order_id>/status')
@login_required
def get_order_status(order_id):
    order = Order.query.get_or_404(order_id)
    
    # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    if current_user.role == 'CUSTOMER':
        if order.customer_id != current_user.id:
            abort(403, '–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –∑–∞–∫–∞–∑—É')
    elif current_user.role == 'OPERATOR':
        if order.operator_id != current_user.id and order.status not in ['paid', 'processing']:
            abort(403, '–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –∑–∞–∫–∞–∑—É')
    elif current_user.role not in ['ADMIN', 'MOM']:
        abort(403, '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤')
    
    return jsonify({'status': order.status})
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ù–´–ô  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í—Ä–µ–º—è:** 4-6 —á–∞—Å–æ–≤ (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ API endpoints)

---

## üü° –í–ê–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞**
**–§–∞–π–ª:** `app/main/payment_routes.py` (—Å—Ç—Ä–æ–∫–∞ ~130-280)  
**–ü—Ä–æ–±–ª–µ–º–∞:**  
```python
# –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
order = Order(...)
db.session.add(order)
db.session.commit()  # ‚ùå –ö–æ–º–º–∏—Ç 1

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
user = User(...)
db.session.add(user)
db.session.commit()  # ‚ùå –ö–æ–º–º–∏—Ç 2

# –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–∫–∞–∑—ã
old_orders = Order.query.filter_by(...)
for old_order in old_orders:
    old_order.status = 'cancelled_unpaid'
db.session.commit()  # ‚ùå –ö–æ–º–º–∏—Ç 3
```

**–ö —á–µ–º—É –ø—Ä–∏–≤–æ–¥–∏—Ç:**
- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –Ω–∞ —à–∞–≥–µ 2 –∏–ª–∏ 3, –∑–∞–∫–∞–∑ —É–∂–µ —Å–æ–∑–¥–∞–Ω
- –ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**
```python
try:
    # ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    # –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–∫–∞–∑—ã
    old_orders = Order.query.filter_by(
        customer_id=customer_id,
        status='awaiting_payment'
    ).all()
    for old_order in old_orders:
        old_order.status = 'cancelled_unpaid'
    
    # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if not user:
        user = User(...)
        db.session.add(user)
        db.session.flush()  # –ü–æ–ª—É—á–∞–µ–º ID –±–µ–∑ –∫–æ–º–º–∏—Ç–∞
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
    order = Order(customer_id=user.id, ...)
    db.session.add(order)
    
    # ‚úÖ –û–¥–∏–Ω –∫–æ–º–º–∏—Ç –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    db.session.commit()
    
except Exception as e:
    db.session.rollback()
    logger.error(f'Error creating order: {e}')
    raise
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–´–°–û–ö–ò–ô  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞

---

### 5. **Race condition –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ webhook –æ—Ç CloudPayments**
**–§–∞–π–ª:** `app/api/cloudpayments_endpoints.py` (—Å—Ç—Ä–æ–∫–∞ ~197-208)  
**–ü—Ä–æ–±–ª–µ–º–∞:**  
–•–æ—Ç—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `with_for_update()`, –Ω–æ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–ª–∞—Ç–µ–∂–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å race condition:

```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
existing_payment = db.session.scalar(
    select(Payment).where(
        Payment.cp_transaction_id == transaction_id
    ).with_for_update()
)

if existing_payment:
    return jsonify({'code': 0}), 200

# ‚ùå –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –≤—Ç–æ—Ä–æ–π webhook
payment = Payment(cp_transaction_id=transaction_id, ...)
db.session.add(payment)
db.session.commit()
```

**–ö —á–µ–º—É –ø—Ä–∏–≤–æ–¥–∏—Ç:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö webhook
- –î–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
from sqlalchemy.exc import IntegrityError

try:
    # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º unique constraint + –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–∫–∏
    payment = Payment(cp_transaction_id=transaction_id, ...)
    db.session.add(payment)
    db.session.commit()
    
except IntegrityError:
    # –ü–ª–∞—Ç–µ–∂ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
    db.session.rollback()
    logger.info(f'Payment {transaction_id} already exists (race condition handled)')
    return jsonify({'code': 0, 'message': 'Already processed'}), 200
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–´–°–û–ö–ò–ô  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–í—Ä–µ–º—è:** 1 —á–∞—Å

---

### 6. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –≤–∏–¥–µ–æ**
**–§–∞–π–ª:** `app/models.py` (Order.get_video_links_expiry)  
**–ü—Ä–æ–±–ª–µ–º–∞:**  
- –ú–µ—Ç–æ–¥ `get_video_links_expiry()` –µ—Å—Ç—å, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- –ö–ª–∏–µ–Ω—Ç—ã –º–æ–≥—É—Ç –ø–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤–∏–¥–µ–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–µ–∫—à–∏—Ö —Å—Å—ã–ª–æ–∫

**–ö —á–µ–º—É –ø—Ä–∏–≤–æ–¥–∏—Ç:**
- –ù–∞—Ä—É—à–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π –ø—Ä–æ–¥–∞–∂–∏ (90 –¥–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞)
- –ü–æ—Ç–µ—Ä—è –¥–æ—Ö–æ–¥–∞ (–∫–ª–∏–µ–Ω—Ç—ã –¥–µ–ª—è—Ç—Å—è —Å—Å—ã–ª–∫–∞–º–∏)
- –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í operator/routes.py –∏–ª–∏ mom/routes.py:
@bp.route('/order/<int:order_id>/video-links')
@login_required
def get_video_links(order_id):
    order = Order.query.get_or_404(order_id)
    
    # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
    expiry_date = order.get_video_links_expiry()
    if expiry_date and moscow_now_naive() > expiry_date:
        return render_template('video_links_expired.html', 
                             order=order, 
                             expiry_date=expiry_date)
    
    return render_template('video_links.html', order=order)

# –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–µ–∫—à–∏—Ö —Å—Å—ã–ª–æ–∫:
def cleanup_expired_video_links():
    """Remove expired video links from orders"""
    from datetime import timedelta
    
    cutoff_date = moscow_now_naive() - timedelta(days=90)
    
    expired_orders = Order.query.filter(
        Order.processed_at < cutoff_date,
        Order.video_links.isnot(None),
        Order.status.in_(['completed', 'completed_partial_refund'])
    ).all()
    
    for order in expired_orders:
        order.video_links = None  # –£–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫–∏
        logger.info(f'Removed expired video links for order {order.id}')
    
    db.session.commit()
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–´–°–û–ö–ò–ô  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í—Ä–µ–º—è:** 3-4 —á–∞—Å–∞

---

### 7. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª—è—Ö**
**–§–∞–π–ª:** `app/models.py`  
**–ü—Ä–æ–±–ª–µ–º–∞:**  
–ü—Ä–æ–≤–µ—Ä–∏–ª –º–æ–¥–µ–ª–∏ - –∏–Ω–¥–µ–∫—Å—ã –µ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–ª—è—Ö, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–∞:
- `Order.processed_at` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫—à–∏—Ö —Å—Å—ã–ª–æ–∫
- `Order.updated_at` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
- `Payment.created_at` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
- `AuditLog.created_at` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤

**–ö —á–µ–º—É –ø—Ä–∏–≤–æ–¥–∏—Ç:**
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–∫–∞–∑–æ–≤
- –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î
- –¢–∞–π–º–∞—É—Ç—ã –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
# flask db migrate -m "Add missing indexes"

# –í –º–∏–≥—Ä–∞—Ü–∏–∏:
def upgrade():
    op.create_index('ix_orders_processed_at', 'orders', ['processed_at'])
    op.create_index('ix_orders_updated_at', 'orders', ['updated_at'])
    op.create_index('ix_payments_created_at', 'payments', ['created_at'])
    op.create_index('ix_audit_logs_created_at', 'audit_logs', ['created_at'])

def downgrade():
    op.drop_index('ix_orders_processed_at', 'orders')
    op.drop_index('ix_orders_updated_at', 'orders')
    op.drop_index('ix_payments_created_at', 'payments')
    op.drop_index('ix_audit_logs_created_at', 'audit_logs')
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–´–°–û–ö–ò–ô  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç

---

### 8. **N+1 –∑–∞–ø—Ä–æ—Å—ã –≤ —Å–ø–∏—Å–∫–∞—Ö –∑–∞–∫–∞–∑–æ–≤**
**–§–∞–π–ª:** `app/admin/routes.py`, `app/operator/routes.py`, `app/mom/routes.py`  
**–ü—Ä–æ–±–ª–µ–º–∞:**  
–í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è eager loading, –Ω–æ –Ω–µ –≤–µ–∑–¥–µ:

```python
# ‚ùå N+1 –ø—Ä–æ–±–ª–µ–º–∞:
orders = Order.query.filter_by(status='paid').all()
for order in orders:
    print(order.customer.email)  # –ó–∞–ø—Ä–æ—Å –∫ –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞
    print(order.event.name)       # –ï—â–µ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
    print(order.athlete.name)     # –ò –µ—â–µ –æ–¥–∏–Ω
```

**–ö —á–µ–º—É –ø—Ä–∏–≤–æ–¥–∏—Ç:**
- –ï—Å–ª–∏ 100 –∑–∞–∫–∞–∑–æ–≤, –±—É–¥–µ—Ç 300+ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
- –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î

**–†–µ—à–µ–Ω–∏–µ:**
```python
from sqlalchemy.orm import joinedload

# ‚úÖ Eager loading:
orders = Order.query.filter_by(status='paid').options(
    joinedload(Order.customer),
    joinedload(Order.event),
    joinedload(Order.category),
    joinedload(Order.athlete),
    joinedload(Order.operator)
).all()

# –¢–µ–ø–µ—Ä—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
for order in orders:
    print(order.customer.email)  # –ë–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    print(order.event.name)       # –ë–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    print(order.athlete.name)     # –ë–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–´–°–û–ö–ò–ô  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å–ø–∏—Å–∫–∏)

---

### 9. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π**
**–§–∞–π–ª:** `app/utils/email.py`  
**–ü—Ä–æ–±–ª–µ–º–∞:**  
```python
def send_email(subject, sender, recipients, text_body, html_body):
    # ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ recipients - –≤–∞–ª–∏–¥–Ω—ã–µ email
    msg = Message(subject, sender=sender, recipients=recipients)
    msg.body = text_body
    msg.html = html_body
    mail.send(msg)
```

**–ö —á–µ–º—É –ø—Ä–∏–≤–æ–¥–∏—Ç:**
- –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∞–¥—Ä–µ—Å–∞
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ email —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞ —Å–ø–∞–º
- –ü–æ—Ç–µ—Ä—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
```python
import re
from email_validator import validate_email, EmailNotValidError

def is_valid_email(email):
    """Validate email address"""
    try:
        validate_email(email, check_deliverability=False)
        return True
    except EmailNotValidError:
        return False

def send_email(subject, sender, recipients, text_body, html_body):
    # ‚úÖ –§–∏–ª—å—Ç—Ä—É–µ–º –≤–∞–ª–∏–¥–Ω—ã–µ email
    valid_recipients = [r for r in recipients if is_valid_email(r)]
    
    if not valid_recipients:
        logger.warning(f'No valid recipients for email: {subject}')
        return False
    
    if len(valid_recipients) < len(recipients):
        invalid = set(recipients) - set(valid_recipients)
        logger.warning(f'Invalid email addresses filtered: {invalid}')
    
    msg = Message(subject, sender=sender, recipients=valid_recipients)
    msg.body = text_body
    msg.html = html_body
    
    try:
        mail.send(msg)
        return True
    except Exception as e:
        logger.error(f'Error sending email: {e}')
        return False
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–´–°–û–ö–ò–ô  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–í—Ä–µ–º—è:** 1 —á–∞—Å

---

### 10. **Telegram bot –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏**
**–§–∞–π–ª:** `app/telegram_bot/bot_manager.py`  
**–ü—Ä–æ–±–ª–µ–º–∞:**  
```python
def send_message(self, chat_id, text):
    # ‚ùå –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
    self.bot.send_message(chat_id, text)
```

**–ö —á–µ–º—É –ø—Ä–∏–≤–æ–¥–∏—Ç:**
- –ü–∞–¥–µ–Ω–∏–µ –±–æ—Ç–∞ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é
- –ü–æ—Ç–µ—Ä—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
```python
import time
from telebot.apihelper import ApiTelegramException

def send_message_with_retry(self, chat_id, text, max_retries=3):
    """Send message with retry logic"""
    for attempt in range(max_retries):
        try:
            self.bot.send_message(chat_id, text)
            return True
            
        except ApiTelegramException as e:
            if e.error_code == 429:  # Too Many Requests
                retry_after = int(e.result_json.get('parameters', {}).get('retry_after', 60))
                logger.warning(f'Rate limit hit, waiting {retry_after} seconds')
                time.sleep(retry_after)
                continue
            elif e.error_code == 403:  # Bot blocked by user
                logger.info(f'Bot blocked by user {chat_id}')
                return False
            else:
                logger.error(f'Telegram API error: {e}')
                if attempt < max_retries - 1:
                    time.sleep(2 ** attempt)  # Exponential backoff
                    continue
                return False
                
        except Exception as e:
            logger.error(f'Unexpected error sending message: {e}')
            if attempt < max_retries - 1:
                time.sleep(2 ** attempt)
                continue
            return False
    
    return False
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–´–°–û–ö–ò–ô  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞

---

### 11. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–ª–µ—Ä—Ç–æ–≤**
**–ü—Ä–æ–±–ª–µ–º–∞:**  
- –ù–µ—Ç —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- –ù–µ—Ç –∞–ª–µ—Ä—Ç–æ–≤ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
- –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ö —á–µ–º—É –ø—Ä–∏–≤–æ–¥–∏—Ç:**
- –£–∑–Ω–∞–µ–º –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
- –î–æ–ª–≥–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è
- –ü–æ—Ç–µ—Ä—è –∑–∞–∫–∞–∑–æ–≤ –∏ –¥–µ–Ω–µ–≥

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –î–æ–±–∞–≤–∏—Ç—å health check endpoint:
@bp.route('/health')
def health_check():
    """Health check endpoint for monitoring"""
    checks = {
        'database': check_database(),
        'redis': check_redis(),
        'email': check_email_server(),
        'telegram': check_telegram_bot(),
        'cloudpayments': check_cloudpayments_api()
    }
    
    all_healthy = all(checks.values())
    status_code = 200 if all_healthy else 503
    
    return jsonify({
        'status': 'healthy' if all_healthy else 'unhealthy',
        'checks': checks,
        'timestamp': moscow_now_naive().isoformat()
    }), status_code

def check_database():
    """Check database connectivity"""
    try:
        db.session.execute('SELECT 1')
        return True
    except:
        return False

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Sentry –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤:
import sentry_sdk
from sentry_sdk.integrations.flask import FlaskIntegration

sentry_sdk.init(
    dsn="YOUR_SENTRY_DSN",
    integrations=[FlaskIntegration()],
    traces_sample_rate=0.1,
    environment="production"
)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–´–°–û–ö–ò–ô  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í—Ä–µ–º—è:** 4-6 —á–∞—Å–æ–≤

---

### 12. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ë–î**
**–ü—Ä–æ–±–ª–µ–º–∞:**  
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –±—ç–∫–∞–ø–æ–≤
- –ù–µ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

**–ö —á–µ–º—É –ø—Ä–∏–≤–æ–¥–∏—Ç:**
- –ü–æ—Ç–µ—Ä—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ–µ –¥–∏—Å–∫–∞
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏ –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π —É—â–µ—Ä–±

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç backup_database.sh:
#!/bin/bash

BACKUP_DIR="/var/backups/mainstream"
DATE=$(date +%Y%m%d_%H%M%S)
DB_PATH="/path/to/instance/app.db"
BACKUP_FILE="$BACKUP_DIR/app_$DATE.db"

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p $BACKUP_DIR

# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
sqlite3 $DB_PATH ".backup '$BACKUP_FILE'"

# –°–∂–∏–º–∞–µ–º
gzip $BACKUP_FILE

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å
gunzip -t "$BACKUP_FILE.gz"

if [ $? -eq 0 ]; then
    echo "Backup successful: $BACKUP_FILE.gz"
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
    find $BACKUP_DIR -name "app_*.db.gz" -mtime +30 -delete
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ S3 –∏–ª–∏ –¥—Ä—É–≥–æ–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    # aws s3 cp "$BACKUP_FILE.gz" s3://mainstream-backups/
else
    echo "Backup verification failed!"
    exit 1
fi
```

```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab:
# 0 2 * * * /path/to/backup_database.sh >> /var/log/backup.log 2>&1
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–´–°–û–ö–ò–ô  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞

---

## üü¢ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ (–°–†–ï–î–ù–ò–ô/–ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

### 13. **–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
**–§–∞–π–ª—ã:** `app/models.py`, `app/utils/settings.py`  
**–ü—Ä–æ–±–ª–µ–º–∞:**  
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –°–ø–∏—Å–∫–∏ —Ç—É—Ä–Ω–∏—Ä–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è —á–∞—Å—Ç–æ
- –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
```python
from flask_caching import Cache

cache = Cache(config={'CACHE_TYPE': 'simple'})

# –í __init__.py:
cache.init_app(app)

# –í utils/settings.py:
@cache.memoize(timeout=300)  # –ö—ç—à –Ω–∞ 5 –º–∏–Ω—É—Ç
def get_video_link_expiry_days():
    setting = SystemSetting.query.filter_by(key='video_link_expiry_days').first()
    return int(setting.value) if setting else 90

# –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏:
def update_setting(key, value):
    setting = SystemSetting.query.filter_by(key=key).first()
    setting.value = value
    db.session.commit()
    cache.delete_memoized(get_video_link_expiry_days)  # –û—á–∏—â–∞–µ–º –∫—ç—à
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –°–†–ï–î–ù–ò–ô  
**–í—Ä–µ–º—è:** 3-4 —á–∞—Å–∞

---

### 14. **–î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –≤ API endpoints**
**–§–∞–π–ª—ã:** `app/api/routes.py`  
**–ü—Ä–æ–±–ª–µ–º–∞:**  
- API –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å—Ä–∞–∑—É
- –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –¥–∞–Ω–Ω—ã—Ö - –º–µ–¥–ª–µ–Ω–Ω–æ –∏ –º–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
```python
@bp.route('/api/orders')
@login_required
def get_orders():
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 20, type=int)
    per_page = min(per_page, 100)  # –ú–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø–∏—Å–µ–π
    
    pagination = Order.query.paginate(
        page=page, per_page=per_page, error_out=False
    )
    
    return jsonify({
        'orders': [order.to_dict() for order in pagination.items],
        'total': pagination.total,
        'pages': pagination.pages,
        'current_page': page,
        'per_page': per_page
    })
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –°–†–ï–î–ù–ò–ô  
**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞

---

### 15. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**
**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í config.py:
SQLALCHEMY_ECHO = False
SQLALCHEMY_RECORD_QUERIES = True
DATABASE_QUERY_TIMEOUT = 0.5  # 500ms

# –í __init__.py:
from flask import request
from sqlalchemy import event
from sqlalchemy.engine import Engine
import time

@event.listens_for(Engine, "before_cursor_execute")
def before_cursor_execute(conn, cursor, statement, parameters, context, executemany):
    conn.info.setdefault('query_start_time', []).append(time.time())

@event.listens_for(Engine, "after_cursor_execute")
def after_cursor_execute(conn, cursor, statement, parameters, context, executemany):
    total = time.time() - conn.info['query_start_time'].pop()
    if total > current_app.config['DATABASE_QUERY_TIMEOUT']:
        logger.warning(f'Slow query ({total:.2f}s): {statement[:200]}')
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –°–†–ï–î–ù–ò–ô  
**–í—Ä–µ–º—è:** 1-2 —á–∞—Å–∞

---

### 16-25. **–î—Ä—É–≥–∏–µ —É–ª—É—á—à–µ–Ω–∏—è**
- –î–æ–±–∞–≤–∏—Ç—å WebSocket –¥–ª—è real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ PostgreSQL –¥–ª—è production
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ
- CDN –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
- –î–æ–±–∞–≤–∏—Ç—å API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (Swagger)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (pytest)
- CI/CD pipeline
- Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- Kubernetes –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üìà –ú–ï–¢–†–ò–ö–ò –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê

### –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã:
- **–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤ Python:** 45
- **–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~31,000
- **–§–∞–π–ª–æ–≤ HTML:** 67
- **–§–∞–π–ª–æ–≤ JavaScript:** 1 (main.js)
- **–ú–æ–¥–µ–ª–µ–π –ë–î:** 10
- **API endpoints:** 28
- **–†–æ—É—Ç–æ–≤:** 87

### –ü–æ–∫—Ä—ã—Ç–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- ‚úÖ SQL Injection: **–ó–∞—â–∏—â–µ–Ω–æ** (ORM)
- ‚úÖ XSS: **–ó–∞—â–∏—â–µ–Ω–æ** (Jinja2 auto-escape)
- ‚úÖ CSRF: **–ó–∞—â–∏—â–µ–Ω–æ** (Flask-WTF)
- ‚ö†Ô∏è IDOR: **–ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞—â–∏—â–µ–Ω–æ** (–Ω—É–∂–Ω—ã –¥–æ—Ä–∞–±–æ—Ç–∫–∏)
- ‚ö†Ô∏è File Upload: **–ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞—â–∏—â–µ–Ω–æ** (–Ω—É–∂–Ω—ã –¥–æ—Ä–∞–±–æ—Ç–∫–∏)
- ‚úÖ XXE: **–ó–∞—â–∏—â–µ–Ω–æ** (defusedxml)
- ‚ö†Ô∏è Rate Limiting: **–ß–∞—Å—Ç–∏—á–Ω–æ** (—Ç–æ–ª—å–∫–æ –Ω–∞ login)
- ‚ùå SAST/DAST: **–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ**

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- ‚ö†Ô∏è N+1 –∑–∞–ø—Ä–æ—Å—ã: **–ï—Å—Ç—å –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö**
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –ë–î: **–û—Å–Ω–æ–≤–Ω—ã–µ –µ—Å—Ç—å, –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ**
- ‚ùå –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ: **–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ**
- ‚ùå CDN: **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**
- ‚ö†Ô∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤: **–ß–∞—Å—Ç–∏—á–Ω–æ**

---

## üéØ –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (1-2 –Ω–µ–¥–µ–ª–∏)
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–∞–π–ª–æ–≤ –≤ —á–∞—Ç–µ
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å Path Traversal —É—è–∑–≤–∏–º–æ—Å—Ç—å
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤ API
4. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
5. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition –≤ webhook

### –§–∞–∑–∞ 2: –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (2-3 –Ω–µ–¥–µ–ª–∏)
6. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –≤–∏–¥–µ–æ
7. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã
8. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –∑–∞–ø—Ä–æ—Å—ã
9. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é email
10. ‚úÖ –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ Telegram bot
11. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã
12. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

### –§–∞–∑–∞ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (3-4 –Ω–µ–¥–µ–ª–∏)
13. –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
14. –î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –≤ API
15. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
16. –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ PostgreSQL
17. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD

### –§–∞–∑–∞ 4: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (1-2 –º–µ—Å—è—Ü–∞)
18. Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
19. Kubernetes
20. CDN –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏
21. WebSocket –¥–ª—è real-time
22. –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–°–∏—Å—Ç–µ–º–∞ –≤ —Ü–µ–ª–æ–º **—Ö–æ—Ä–æ—à–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞** –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–≤—è–∑–∞–Ω—ã —Å:

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é** - –Ω—É–∂–Ω–æ —É—Å–∏–ª–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é** - –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é** - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –±—ç–∫–∞–ø—ã

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π:**
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å 3 –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (1-2 –¥–Ω—è)
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 –Ω–µ–¥–µ–ª–∏)
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –±—ç–∫–∞–ø—ã (3-5 –¥–Ω–µ–π)
4. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –≤–Ω–µ–¥—Ä—è—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ production:** 7.5/10
- –î–ª—è –∑–∞–ø—É—Å–∫–∞: **–ì–æ—Ç–æ–≤–æ** (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º)
- –î–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è: **–¢—Ä–µ–±—É—é—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∏**
- –î–ª—è enterprise: **–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞**

---

**–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞:** 7 –Ω–æ—è–±—Ä—è 2024  
**–ê—É–¥–∏—Ç–æ—Ä:** AI Code Reviewer  
**–í–µ—Ä—Å–∏—è:** 1.0

