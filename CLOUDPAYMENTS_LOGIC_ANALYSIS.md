# –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã CloudPayments

## üîç –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. **–†–∞–∑–Ω—ã–µ –º–µ—Ç–æ–¥—ã –≤ —Ä–∞–∑–Ω—ã—Ö —à–∞–±–ª–æ–Ω–∞—Ö**
- `payment.html` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç: `widget.charge()`
- `checkout.html` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç: `widget.pay('charge', ...)`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –†–∞–∑–Ω—ã–µ API –º–µ—Ç–æ–¥—ã –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ-—Ä–∞–∑–Ω–æ–º—É

### 2. **–§–æ—Ä–º–∞—Ç –ø–æ–¥–ø–∏—Å–∏ webhook**
- CloudPayments –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –≤ **base64** —Ñ–æ—Ä–º–∞—Ç–µ
- –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–ª –≤ **hex** —Ñ–æ—Ä–º–∞—Ç–µ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

### 3. **–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö webhook**
- CloudPayments –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `application/x-www-form-urlencoded`
- –ö–æ–¥ –æ–∂–∏–¥–∞–ª JSON (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

### 4. **–ü–æ–ª—É—á–µ–Ω–∏–µ raw_data –¥–ª—è –ø–æ–¥–ø–∏—Å–∏**
- –ù—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –î–û –ø–∞—Ä—Å–∏–Ω–≥–∞ request.form
- Flask –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç form-data, –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `request.get_data()`

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´

### –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
1. –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ ‚Üí —Å—Ç–∞—Ç—É—Å `checkout_initiated`
2. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã ‚Üí `/checkout` –∏–ª–∏ `/payment`

### –≠—Ç–∞–ø 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞
1. JavaScript –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ: `POST /api/payment/create`
2. –°–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–∂–µ—Ç–∞ —á–µ—Ä–µ–∑ `create_payment_widget_data()`
3. –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `awaiting_payment`
4. –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ: `{publicId, description, amount, currency, invoiceId, email}`

### –≠—Ç–∞–ø 3: CloudPayments Widget
1. –í–∏–¥–∂–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å –¥–∞–Ω–Ω—ã–º–∏
2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `widget.charge()` –∏–ª–∏ `widget.pay('charge', ...)`
3. CloudPayments –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂

### –≠—Ç–∞–ø 4: Webhook Check (–ø–µ—Ä–µ–¥ –ø–ª–∞—Ç–µ–∂–æ–º)
1. CloudPayments –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `POST /api/cloudpayments/webhook`
2. `NotificationType: Check`
3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–∫–∞–∑ –∏ —Å—É–º–º—É
5. –í–æ–∑–≤—Ä–∞—â–∞–µ–º `{code: 0}` –µ—Å–ª–∏ –≤—Å–µ –û–ö

### –≠—Ç–∞–ø 5: Webhook Pay (–ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞)
1. CloudPayments –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `POST /api/cloudpayments/webhook`
2. `NotificationType: Pay`
3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
4. –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å `Payment` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `authorized`
5. –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –Ω–∞ `paid`
6. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email –∫–ª–∏–µ–Ω—Ç—É

### –≠—Ç–∞–ø 6: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (MOM)
1. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂
2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è API `confirm_payment()`
3. CloudPayments API: `POST /payments/confirm`
4. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ `confirmed`

## üîß –ß–¢–û –ü–†–û–í–ï–†–ò–¢–¨

### –í .env —Ñ–∞–π–ª–µ:
```env
CLOUDPAYMENTS_PUBLIC_ID=pk_...          # –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
CLOUDPAYMENTS_API_SECRET=...            # –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (32+ —Å–∏–º–≤–æ–ª–æ–≤)
CLOUDPAYMENTS_TEST_MODE=True            # –î–ª—è —Ç–µ—Å—Ç–æ–≤
CLOUDPAYMENTS_WEBHOOK_URL=https://mainstreamfs.ru/api/cloudpayments/webhook
```

### –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ CloudPayments:
1. ‚úÖ URL webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
2. ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π/–±–æ–µ–≤–æ–π —Ä–µ–∂–∏–º —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `CLOUDPAYMENTS_TEST_MODE`
3. ‚úÖ API –∫–ª—é—á–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ

### –í –∫–æ–¥–µ:
1. ‚úÖ –ü–æ–¥–ø–∏—Å—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ base64 —Ñ–æ—Ä–º–∞—Ç–µ
2. ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–∞—Ä—Å—è—Ç—Å—è –∫–∞–∫ form-urlencoded
3. ‚úÖ Raw –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—é—Ç—Å—è –î–û –ø–∞—Ä—Å–∏–Ω–≥–∞

## üìù –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –¢–ï–°–¢–û–í–´–ô –°–ö–†–ò–ü–¢

–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
cd ~/mainstreamfs.ru
source venv/bin/activate
python3 test_cloudpayments_api.py
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç:
1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (.env —Ñ–∞–π–ª)
2. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∏
3. –ü–∞—Ä—Å–∏–Ω–≥ form-urlencoded
4. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–∞
5. –°–∏–º—É–ª—è—Ü–∏—é webhook

