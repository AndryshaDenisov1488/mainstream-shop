# üí≥ –õ–û–ö–ê–õ–¨–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï CLOUDPAYMENTS

## ‚úÖ –ú–û–ñ–ù–û –¢–ï–°–¢–ò–¢–¨ –õ–û–ö–ê–õ–¨–ù–û!

–î–∞, CloudPayments API **–ø–æ–ª–Ω–æ—Å—Ç—å—é –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ** —Å –ø–æ–º–æ—â—å—é —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞.

---

## üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢ (–ë–ï–ó WEBHOOK)

### 1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `.env` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```env
# –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º CloudPayments
CLOUDPAYMENTS_PUBLIC_ID=pk_test_–≤–∞—à_—Ç–µ—Å—Ç–æ–≤—ã–π_–∫–ª—é—á
CLOUDPAYMENTS_API_SECRET=–≤–∞—à_—Ç–µ—Å—Ç–æ–≤—ã–π_—Å–µ–∫—Ä–µ—Ç
CLOUDPAYMENTS_TEST_MODE=True

# –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
PORT=5000
SITE_URL=http://localhost:5000
```

### 2. –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã CloudPayments

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–∏ –∫–∞—Ä—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

| –¢–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏ | –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-------------|-------------|-----------|
| –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ | `4111 1111 1111 1111` | ‚úÖ –ü–ª–∞—Ç–µ–∂ –ø—Ä–æ—Ö–æ–¥–∏—Ç |
| –û—Ç–∫–∞–∑ –±–∞–Ω–∫–∞ | `4111 1111 1111 1112` | ‚ùå –ë–∞–Ω–∫ –æ—Ç–∫–ª–æ–Ω–∏–ª |
| 3D Secure | `4111 1111 1111 1113` | üîê –ó–∞–ø—Ä–æ—Å 3DS |
| –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ | `4111 1111 1111 1114` | ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ |

**CVV –∏ –¥–∞—Ç–∞:** –ª—é–±—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `123` –∏ `12/25`)

### 3. –ß—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å:

‚úÖ **–í–∏–¥–∂–µ—Ç –æ–ø–ª–∞—Ç—ã** - –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π** - –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è  
‚úÖ **–¢–µ—Å—Ç–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** - –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏  
‚ö†Ô∏è **Webhook** - –ù–ï –ø—Ä–∏–¥–µ—Ç –Ω–∞ localhost (—Å–º. –Ω–∏–∂–µ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è)

---

## üîß –ü–û–õ–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –° WEBHOOK (—á–µ—Ä–µ–∑ ngrok)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å webhook'–∏ –æ—Ç CloudPayments:

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ngrok

**Windows:**
```powershell
# –ß–µ—Ä–µ–∑ Chocolatey
choco install ngrok

# –ò–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ —Å https://ngrok.com/download
```

**Linux/Mac:**
```bash
# –ß–µ—Ä–µ–∑ Homebrew
brew install ngrok

# –ò–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ —Å https://ngrok.com/download
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç–µ ngrok

–í **–Ω–æ–≤–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ** –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```bash
ngrok http 5000
```

–í—ã —É–≤–∏–¥–∏—Ç–µ —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:
```
Forwarding  https://abc123def456.ngrok-free.app -> http://localhost:5000
```

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL: `https://abc123def456.ngrok-free.app`

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook –≤ CloudPayments

1. –ó–∞–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç CloudPayments
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí Webhook
3. –£–∫–∞–∂–∏—Ç–µ URL: `https://–≤–∞—à-ngrok-url.ngrok-free.app/api/cloudpayments/webhook`

### –®–∞–≥ 4: –û–±–Ω–æ–≤–∏—Ç–µ `.env`

```env
CLOUDPAYMENTS_WEBHOOK_URL=https://–≤–∞—à-ngrok-url.ngrok-free.app/api/cloudpayments/webhook
```

### –®–∞–≥ 5: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
python run.py
```

---

## üìù –ü–û–õ–ù–´–ô –ü–†–ò–ú–ï–† .env –î–õ–Ø –õ–û–ö–ê–õ–¨–ù–û–ì–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

```env
# –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
FLASK_ENV=development
FLASK_DEBUG=True

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DATABASE_URL=sqlite:///instance/app.db

# CloudPayments - –¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú
CLOUDPAYMENTS_PUBLIC_ID=pk_test_–≤–∞—à_—Ç–µ—Å—Ç–æ–≤—ã–π_public_id
CLOUDPAYMENTS_API_SECRET=–≤–∞—à_—Ç–µ—Å—Ç–æ–≤—ã–π_api_secret
CLOUDPAYMENTS_TEST_MODE=True
CLOUDPAYMENTS_WEBHOOK_URL=https://–≤–∞—à-ngrok.ngrok-free.app/api/cloudpayments/webhook

# –ò–ª–∏ –±–µ–∑ ngrok (–±–µ–∑ webhook'–æ–≤):
# CLOUDPAYMENTS_WEBHOOK_URL=http://localhost:5000/api/cloudpayments/webhook

# –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
PORT=5000
SITE_URL=http://localhost:5000

# –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (—Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
TEST_MODE=True

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–ª–æ–∫–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ False)
SESSION_COOKIE_SECURE=False
WTF_CSRF_SSL_STRICT=False
```

---

## üß™ –°–¶–ï–ù–ê–†–ò–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### 1. –ü—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞ (–ë–ï–ó webhook)

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑
3. –ù–∞–∂–º–∏—Ç–µ "–û–ø–ª–∞—Ç–∏—Ç—å"
4. –í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É `4111 1111 1111 1111`
5. ‚úÖ –í–∏–¥–∂–µ—Ç –ø–æ–∫–∞–∂–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–ª–∞—Ç—ã

**–ß—Ç–æ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å:**
- Webhook'–∏ –æ—Ç CloudPayments (–æ–Ω–∏ –Ω–µ –ø—Ä–∏–¥—É—Ç –Ω–∞ localhost)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ webhook

**–ß—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é:**
- –û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω–∫—É
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞

### 2. –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –° webhook

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ ngrok
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook URL –≤ CloudPayments
3. –û–±–Ω–æ–≤–∏—Ç–µ `.env`
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
5. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑ –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ
6. ‚úÖ Webhook –ø—Ä–∏–¥–µ—Ç –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç —Å—Ç–∞—Ç—É—Å

---

## üîç –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–´

### –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–∫–∞–∂—É—Ç:

```
INFO  CloudPayments API initialized:
INFO    Public ID: pk_test_xxx...
INFO    API Secret: ********************
INFO    Currency: RUB
INFO    Test Mode: True
INFO    Base URL: https://api.cloudpayments.ru
```

### –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ ngrok –≤—ã —É–≤–∏–¥–∏—Ç–µ:

```
POST /api/cloudpayments/webhook    200 OK
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

1. **–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!**
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `CLOUDPAYMENTS_TEST_MODE=True`
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏ (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å `pk_test_`)

2. **–ë–µ–∑ ngrok webhook'–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç**
   - CloudPayments –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å webhook –Ω–∞ `localhost`
   - –ù–æ –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç

3. **–¢–µ—Å—Ç–æ–≤—ã–µ –¥–µ–Ω—å–≥–∏**
   - –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–µ–Ω–µ–≥ –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
   - –ú–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ

4. **–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω**
   - –ó–∞–º–µ–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏ –Ω–∞ –±–æ–µ–≤—ã–µ
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `CLOUDPAYMENTS_TEST_MODE=False`
   - –£–∫–∞–∂–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π webhook URL

---

## üÜò –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú

### –ü—Ä–æ–±–ª–µ–º–∞: "CloudPayments credentials not configured"

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ `.env` —Ñ–∞–π–ª–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `CLOUDPAYMENTS_PUBLIC_ID` –∏ `CLOUDPAYMENTS_API_SECRET` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

### –ü—Ä–æ–±–ª–µ–º–∞: Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ ngrok –∑–∞–ø—É—â–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö CloudPayments
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–ª—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—Ç (5000)

### –ü—Ä–æ–±–ª–µ–º–∞: –í–∏–¥–∂–µ—Ç –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –Ω–∞ –æ—à–∏–±–∫–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `CLOUDPAYMENTS_PUBLIC_ID` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `TEST_MODE=True` (–µ—Å–ª–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç–µ –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø

- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è CloudPayments:** https://cloudpayments.ru/docs/
- **–¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã:** https://cloudpayments.ru/docs/testing
- **ngrok –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** https://ngrok.com/docs

---

## ‚úÖ –ò–¢–û–ì–û

**–î–∞, CloudPayments –º–æ–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ!**

- –ë–µ–∑ ngrok: —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç–µ –≤–∏–¥–∂–µ—Ç –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
- –° ngrok: —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç–µ –≤—Å–µ, –≤–∫–ª—é—á–∞—è webhook'–∏

–î–ª—è –Ω–∞—á–∞–ª–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –∫–ª—é—á–∞–º–∏.

